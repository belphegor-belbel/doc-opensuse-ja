<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter [
<!ENTITY % entities SYSTEM "generic-entities.ent">
%entities;
]>
<chapter xmlns:its="http://www.w3.org/2005/11/its" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vm_security.xml" version="5.0" xml:id="cha-vm-security">
  <title>AMD SEV-SNP による仮想マシンのセキュリティ強化</title>
  <info>
    <meta name="description" its:translate="yes">仮想マシンのセキュリティ分離とデータ保護の機能を提供する AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP) の有効化について説明しています</meta>
    <abstract>
      <para>AMD 社が提供する Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP) を使用することで、お使いの仮想マシンに対するセキュリティを強化することができます。 AMD SEV-SNP 機能は仮想マシンをホストシステムや他の仮想マシンから切り離し、データやコードの保護を提供する仕組みです。この機能ではデータを暗号化するほか、仮想マシン内で実行するコードやデータを検出して追跡する仕組みを備えています。この仕組みにより仮想マシンを分離することができますので、たとえ仮想マシンが不正侵入された場合であっても、他の仮想マシンやホストマシンに影響が無いようにすることができます。</para>

      <para>本章では、お使いの AMD EPYC サーバで &productname; &productnumber; を利用した際に、 AMD SEV-SNP 機能を有効化するための手順を説明しています。</para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  <revhistory xml:id="rh-cha-vm-security">
   <revision>
     <date>2025-06-12</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>
  <sect1 xml:id="sec-vm-security-hardware-support">
    <title>対応するハードウエア</title>

    <para>AMD SEV-SNP 仮想マシンを実行するには、 AMD 社の EPYC (第 3 世代もしくはそれ以降) を搭載したシステムが必要となります。また、 BIOS 設定でコンフィデンシャル・コンピューティング機能を有効化する設定が提供されている必要もあります。</para>
  </sect1>
  <sect1 xml:id="sec-vm-security-setup">
    <title>システムの基礎部分の設定</title>
    <para>AMD SEV-SNP を有効化した &vmguest; を動作させるには、まず &vmhost; 側において設定調整を実施する必要があります。 SUSE Linux Enterprise Server 15 SP7 では、既定の IOMMU はパススルーに設定されていますが、 AMD SEV-SNP を使用するには非パススルーモードに設定しなければなりません。これは、暗号化された &vmguest; からメモリを介して物理デバイスにアクセスしてしまうと、データの整合性が損なわれる危険性があるためです。なお、任意でインストールする <command>snphost</command> ツールを利用するには、 MSR カーネルモジュールが必要となります。</para>
    <procedure>
       <step>
        <para><literal>msr</literal> モジュールを起動時に読み込むように設定するには、下記のように実行します:</para>
<screen>&prompt.sudo; <command>echo "msr" &gt; /etc/modules-load.d/msr.conf</command></screen>
      </step>
      <step>
        <para>&productname; &productnumber; で IOMMU の設定を無効化するには、 <filename>/etc/default/grub</filename> ファイルを開いて、 <varname>GRUB_CMDLINE_LINUX_DEFAULT</varname> 変数内に <literal>iommu=nopt</literal> を追加します。</para>
      </step>
      <step>
        <para>設定変更後はブートローダの設定を更新します。下記のコマンドを実行してください:</para>
<screen>&prompt.sudo;; <command>update-bootloader</command></screen>
      </step>
      <step>
        <para>あとはシステムを再起動することで、 Confidential Compute Module が有効化されたカーネルを起動することができます。なお、ブートローダ側の設定で既定のカーネルとして選択されていない場合は、起動メニューで選択しておいてください。</para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify">
    <title>設定の確認</title>

    <para>&vmhost; のインストールと設定が正しくできているかどうかを確認するには、 dmesg もしくは任意でインストールする <command>snphost</command> ツールを使用します。</para>
    <procedure>
      <step>
        <para>また、カーネルの起動時に AMD Secure Processor の初期化結果が出力されていることを確認します。下記のようにコマンドを実行して確認してください:</para>
<screen>&prompt.sudo; <command>dmesg | grep -i ccp</command>
[ 10.103166] ccp 0000:42:00.1: enabling device (0000 -&gt; 0002)
[ 10.114951] ccp 0000:42:00.1: no command queues available
[ 10.127137] ccp 0000:42:00.1: sev enabled
[ 10.133152] ccp 0000:42:00.1: psp enabled
[ 10.240817] ccp 0000:42:00.1: SEV firmware update successful
[ 11.128307] ccp 0000:42:00.1: SEV API:1.55 build:8
[ 11.135057] ccp 0000:42:00.1: SEV-SNP API:1.55 build:8</screen>
        <para>上記のように SEV-SNP API のバージョン文字列が表示されていれば、 AMD Secure Processor の準備ができたことになります。なお、上記のように表示されていない場合は、 BIOS 設定が正しくないか、 IOMMU の設定が更新されていないものと考えられます。</para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-vm-install">
    <title>AMD SEV-SNP 仮想マシンのインストール</title>

    <para>&vmhost; 側で設定作業を行い、 AMD Secure Processor の初期化を行ったあとは、 &libvirt; フレームワークで AMD SEV-SNP による保護のある仮想マシンを作成し、インストールすることができます。インストールの手順は通常と同じで、 <xref linkend="cha-kvm-inst"/> に示している手順でインストールを行うことができます。ただし、仮想 CD-ROM ドライブによる ISO イメージからのインストールには対応していません。その他の詳しい制限事項については、制限事項の章をお読みください。</para>

    <para>なお、仮想 CD-ROM 以外にも、 AMD SEV-SNP で保護した仮想マシンの場合、 &vmhost; が提供する TPM デバイスは利用できません。インストール時の設定に含まれている場合は、これを取り除いてください。このほか、 SEV-SNP で保護した仮想マシンは再起動にも対応していません。そのため、インストール中に再起動が必要となる場合は、いったんシャットダウンするように設定してください。その他の詳しい制限事項については、制限事項の章をお読みください。</para>
    <para>また <xref linkend="sec-libvirt-inst-vmm"/> では、 virt-manager を利用した GUI ベースの仮想マシンインストールの手順を説明しています。なお、 AMD SEV-SNP を有効化するには、 <guilabel>新しい仮想マシンの作成</guilabel> の最後で <guilabel>完了</guilabel> を押す前に、 <guilabel>インストールの前に設定をカスタマイズする</guilabel> を選択する必要があることに注意してください。 &vmguest; の設定ダイアログが表示されたら、 <guilabel>メモリー</guilabel> を選んで <guilabel>Enable launch security</guilabel> のチェックボックスを選択して <guilabel>適用</guilabel> を押します。あとは <guilabel>インストールの開始</guilabel> を選択するだけで、 <xref linkend="sec-libvirt-inst-vmm"/> で示した手順でインストールを行うことができます。</para>

    <para>このほか <xref linkend="sec-libvirt-inst-virt-install"/> では、 <command>virt-install</command> による仮想マシンインストールを説明しています。 AMD SEV-SNP を有効化したい場合は、 <option>--launchSecurity</option> オプションを指定してください。下記は <xref linkend="ex-libvirt-inst-virt-install-example"/> でのインストールの際、 AMD SEV-SNP による保護を追加した場合の例です:</para>
<screen>&prompt.user;virt-install --connect qemu:///system --virt-type kvm \
--name sle15sp7 --memory 4096 --disk size=60 --location /path/to/iso --graphics vnc \
--os-variant sle15sp7 --boot uefi --events on_reboot=destroy --launchSecurity type=sev-snp </screen>
    <para>なお、 <option>--launchSecurity</option> に関する詳細については、 <link xlink:href="https://libvirt.org/formatdomain.html#launch-security"/> にある <citetitle>Domain XML format</citetitle> マニュアル内の <citetitle>Launch Security</citetitle> の章をお読みください。</para>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify-vm">
    <title>AMD SEV-SNP 仮想マシンの確認</title>

    <para>仮想マシンの実行状態だけではコンフィデンシャル・コンピューティングが有効化されているかどうかがわかりません。代わりに仮想マシン内で確認する方法がいくつか提供されています。</para>

    <para>カーネルのログには、仮想マシン内での AMD メモリ暗号化機能に関するメッセージが出力されます。カーネルのログを確認するには、下記のようなコマンドを実行します:</para>

<screen>&prompt.sudo; <command>dmesg | grep -i sev-snp</command>
[ 1.986186] Memory Encryption Features active: AMD SEV SEV-ES SEV-SNP</screen>

    <para>カーネルログ内にメモリの暗号化機能として SEV-SNP が表示されていれば、コンフィデンシャル・コンピューティングが動作していて、仮想マシンに対してそれが有効化されていることがわかります。</para>

    <para>仮想マシン内から SEV-SNP 機能が有効化されているかどうかを確認したい場合は、任意でインストールできる <command>snpguest</command> ツールを使用します。 <command>snphost</command> ツールと同様に、 <command>snpguest</command> では MSR カーネルモジュールが必要となります。仮想マシン内でメモリ暗号化機能の状態を確認するには、下記のようなコマンドを実行します:</para>

<screen>&prompt.sudo; <command>modprobe msr &amp;&amp; snpguest ok</command>
[ PASS ] - SEV: ENABLED
[ PASS ] - SEV-ES: ENABLED
[ PASS ] - SNP: ENABLED
</screen>

    <para>AMD SEV-SNP 環境でセキュリティを証明するための、暗号方式として安全な方法もあります。</para>
  </sect1>

  <sect1 xml:id="sec-vm-security-snp-attestation">
    <title>AMD SEV-SNP 仮想マシンの認証</title>

    <para>SEV-SNP の有効化が確認できたら、あとは認証処理を行うことで仮想マシンの機密性を確立することができるようになります。この認証処理は暗号処理をベースにした認証で、階層構造による証明関係を構築することで、検証済みのファームウエアや TCB レベルを使用した、正規の AMD ハードウエアであることを証明します。</para>

    <para>なお、下記の手順ではローカルでの認証確認のみを実施することに注意してください。ゲスト内で生成されたレポート署名と証明書の連鎖を検証するとともに、認証データがプラットフォームの状態と一致していることを確認します。認証レポートを外部の検証器や検証サービスに送信して、プラットフォームの信頼性を独自に確認し、機密データや処理の認可を行うようなリモート認証は行いません。</para>

    <para>認証処理に際しては、 <command>snpguest</command> と <command>snphost</command> というツールを使用します。</para>

    <sect2 xml:id="sec-vm-security-snp-attestation-guest">
      <title>認証レポートの生成と検証</title>

       <para>ゲスト内で <command>snpguest</command> ツールを使用することで、認証ワークフローを実行することができます。この処理では認証レポートを生成し、それぞれの AMD 証明書の連鎖にアクセスして、正しいプラットフォーム鍵で電子的に署名されていることを検証します。</para>

      <procedure>
        <step>
          <para>まずは認証レポートと対応する要求ファイルを生成します。 <option>--random</option> フラグを指定することで、唯一性を保証するための乱数データを含めることができます:</para>
          <screen>&prompt.sudo;<command>snpguest report attestation-report.bin request-file.bin --random</command></screen>
        </step>

        <step>
          <para>次に鍵配布サービス (KDS) から AMD CA と ASK の各証明書を DER 形式で取得します。ここで、 <literal>genoa</literal> の箇所にはプロセッサモデルを指定します (モデルが異なる場合は変更してください):</para>
        <screen>&prompt.sudo;<command>snpguest fetch ca der genoa ./certs-kds</command></screen>
        </step>

        <step>
          <para>さらに生成された認証レポートを利用して、 Versioned Chip Endorsement Key (VCEK) を取得します:</para>
          <screen>&prompt.sudo;<command>snpguest fetch vcek der genoa ./certs-kds attestation-report.bin</command></screen>
        </step>

        <step>
          <para>取得した証明書を利用して、認証レポートを検証します:</para>
          <screen>&prompt.sudo;<command>snpguest verify attestation ./certs-kds attestation-report.bin</command>

Reported TCB Boot Loader from certificate matches the attestation report.
Reported TCB TEE from certificate matches the attestation report.
Reported TCB SNP from certificate matches the attestation report.
Reported TCB Microcode from certificate matches the attestation report.
Chip ID from certificate matches the attestation report.
VEK signed the Attestation Report!
          </screen>
        </step>
      </procedure>
    
      <note>
        <para>なお、 <command>snpguest certificates</command> コマンドを利用した拡張型の認証ワークフローは QEMU 側の機能に依存して動作するものですが、こちらは現時点では利用できません。</para>
      </note>
    </sect2>

    <sect2 xml:id="sec-vm-security-snp-attestation-host">
      <title>ホスト側での AMD 証明書の検証</title>
    <para>ホスト側では、必要に応じてゲスト側の認証レポートを検証するための AMD 証明書連鎖を取得および検証することができます。</para>

    <procedure>
        <step>
          <para>AMD 社の鍵配布サービス (KDS) から AMD CA と ASK の各証明書を取得します:</para>
<screen>&prompt.sudo; snphost fetch ca pem ./certs</screen>
        </step>

        <step>
          <para>次に、プラットフォームに対応した Chip Endorsement Certificate (VCEK または VLEK) を取得します:</para>
<screen>&prompt.sudo; snphost fetch vek pem ./certs</screen>
        </step>

        <step>
          <para>取得した証明書の連鎖の正当性を検証します:</para>
<screen>&prompt.sudo; <command>snphost verify ./certs</command>
• = self signed, ⬑ = signs, •̷ = invalid self sign, ⬑̸ = invalid signs

ARK •
ARK ⬑ ASK
ASK ⬑ VCEK
          </screen>
        </step>
      </procedure>
    </sect2>      
  </sect1>

  <sect1 xml:id="sec-vm-security-sev-snp-limits">
    <title>現時点での制限事項</title>

    <para>SEV-SNP を有効化した &vmguest; を動作させた場合、下記の制限があることに注意してください。</para>

    <itemizedlist>
      <listitem>
        <para>SEV-SNP で保護された VM 内で動作させるオペレーティングシステムは、 SEV-SNP に対応していなければなりません。 &sls; 15 SP6 またはそれ以降のバージョンであれば、 SEV-SNP に対応しています。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; の場合、 <command>virt-install</command> で <option>--cdrom</option> オプションを指定したインストールは実施できません。代わりに <option>--location</option> オプションをお使いください。なお、 <option>--location</option> オプションに関する説明については、 <command>virt-install</command> のマニュアルページをお読みください。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、仮想 CPU 数は最大 255 個までの対応となります。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; は Secure Boot との互換性がありません。 Secure Boot サポートが有効化された UEFI ファームウエアを使用すると、 SEV-SNP 対応の &vmguest; が動作しなくなります。</para>
      </listitem>
      <listitem>
	<para>SEV-SNP で保護された &vmguest; は、 &vmhost; の提供する TPM デバイスを使用できません。これは TPM デバイスを擬似する場合と、パススルーする場合の両方に当てはまります。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、ホストデバイスのパススルー (PCI パススルー) を使用することができません。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、メモリバルーン機能には対応しません。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、メモリや仮想 CPU のホットプラグには対応しません。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、 huge page 機能には対応しません。</para>
      </listitem>
      <listitem>
        <para>SEV-SNP で保護された &vmguest; では、 <command>reboot</command> や <command>shutdown -r now</command> で再起動を行うことができません。再起動はいったんシャットダウンしてから起動し直す方式になります。</para>
      </listitem>
      <listitem>
        <para>&vmguest; のメモリ内容の保存と復元 (つまり &vmguest; の状態保存) には対応していません。言い換えると、 SEV-SNP で保護された &vmguest; ではスナップショット機能が利用できないばかりか、ライブマイグレーションにも対応できません。 SEV-SNP を別のホストに移行したい場合は、いったんシャットダウンして移行し、移行先で起動し直す手順が必要になります。</para>
      </listitem>
    </itemizedlist>

    <para>これらの制限事項は様々なハードウエアやファームウェア、およびソフトウエアの特定レイヤが原因となって発生しているもので、将来的に解決できるかもしれません。</para>
  </sect1>
</chapter>

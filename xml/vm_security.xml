<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter [
<!ENTITY % entities SYSTEM "generic-entities.ent">
%entities;
]>
<chapter xmlns:its="http://www.w3.org/2005/11/its" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="vm_security.xml" version="5.0" xml:id="cha-vm-security">
  <title>AMD SEV-SNP による仮想マシンのセキュリティ強化</title>
  <info>
    <meta name="description" its:translate="yes">仮想マシンのセキュリティ分離とデータ保護の機能を提供する AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP) の有効化について説明しています</meta>
    <abstract>
      <para>AMD 社が提供する Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP) を使用することで、お使いの仮想マシンに対するセキュリティを強化することができます。 AMD SEV-SNP 機能は仮想マシンをホストシステムや他の仮想マシンから切り離し、データやコードの保護を提供する仕組みです。この機能ではデータを暗号化するほか、仮想マシン内で実行するコードやデータを検出して追跡する仕組みを備えています。この仕組みにより仮想マシンを分離することができますので、たとえ仮想マシンが不正侵入された場合であっても、他の仮想マシンやホストマシンに影響が無いようにすることができます。</para>

      <para>本章では、お使いの AMD EPYC サーバで &productname; &productnumber; を利用した際に、 AMD SEV-SNP 機能を有効化するための手順を説明しています。</para>
    </abstract>
    <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
      <dm:bugtracker/>
      <dm:translation>yes</dm:translation>
    </dm:docmanager>
  <revhistory xml:id="rh-cha-vm-security">
   <revision>
     <date>2025-06-12</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>
  <sect1 xml:id="sec-vm-security-hardware-support">
    <title>対応するハードウエア</title>

    <para>AMD SEV-SNP 仮想マシンを実行するには、 AMD 社の EPYC (第 3 世代もしくはそれ以降) を搭載したシステムが必要となります。また、 BIOS 設定でコンフィデンシャル・コンピューティング機能を有効化する設定が提供されている必要もあります。</para>
  </sect1>
  <sect1 xml:id="sec-vm-security-setup">
    <title>システムの基礎部分の設定</title>
    <para>AMD SEV-SNP を有効化した &vmguest; を動作させるには、まず &vmhost; 側において設定調整を実施する必要があります。 SUSE Linux Enterprise Server 15 SP7 では、既定の IOMMU はパススルーに設定されていますが、 AMD SEV-SNP を使用するには非パススルーモードに設定しなければなりません。これは、暗号化された &vmguest; からメモリを介して物理デバイスにアクセスしてしまうと、データの整合性が損なわれる危険性があるためです。なお、任意でインストールする <command>snphost</command> ツールを利用するには、 MSR カーネルモジュールが必要となります。</para>
    <procedure>
       <step>
        <para><literal>msr</literal> モジュールを起動時に読み込むように設定するには、下記のように実行します:</para>
<screen>&prompt.sudo; <command>echo "msr" &gt; /etc/modules-load.d/msr.conf</command></screen>
      </step>
      <step>
        <para>&productname; &productnumber; で IOMMU の設定を無効化するには、 <filename>/etc/default/grub</filename> ファイルを開いて、 <varname>GRUB_CMDLINE_LINUX_DEFAULT</varname> 変数内に <literal>iommu=nopt</literal> を追加します。</para>
      </step>
      <step>
        <para>設定変更後はブートローダの設定を更新します。下記のコマンドを実行してください:</para>
<screen>&prompt.sudo;; <command>update-bootloader</command></screen>
      </step>
      <step>
        <para>あとはシステムを再起動することで、 Confidential Compute Module が有効化されたカーネルを起動することができます。なお、ブートローダ側の設定で既定のカーネルとして選択されていない場合は、起動メニューで選択しておいてください。</para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify">
    <title>設定の確認</title>

    <para>&vmhost; のインストールと設定が正しくできているかどうかを確認するには、 dmesg もしくは任意でインストールする <command>snphost</command> ツールを使用します。</para>
    <procedure>
      <step>
        <para>また、カーネルの起動時に AMD Secure Processor の初期化結果が出力されていることを確認します。下記のようにコマンドを実行して確認してください:</para>
<screen>&prompt.sudo; <command>dmesg | grep -i ccp</command>
[ 10.103166] ccp 0000:42:00.1: enabling device (0000 -&gt; 0002)
[ 10.114951] ccp 0000:42:00.1: no command queues available
[ 10.127137] ccp 0000:42:00.1: sev enabled
[ 10.133152] ccp 0000:42:00.1: psp enabled
[ 10.240817] ccp 0000:42:00.1: SEV firmware update successful
[ 11.128307] ccp 0000:42:00.1: SEV API:1.55 build:8
[ 11.135057] ccp 0000:42:00.1: SEV-SNP API:1.55 build:8</screen>
        <para>上記のように SEV-SNP API のバージョン文字列が表示されていれば、 AMD Secure Processor の準備ができたことになります。なお、上記のように表示されていない場合は、 BIOS 設定が正しくないか、 IOMMU の設定が更新されていないものと考えられます。</para>
      </step>
    </procedure>
  </sect1>
  <sect1 xml:id="sec-vm-security-vm-install">
    <title>AMD SEV-SNP 仮想マシンの起動</title>

    <para>
      You can create and install AMD SEV-SNP protected virtual machines using the &libvirt;
      framework once the &vmhost; is properly configured and the AMD Secure Processor is
      initialized. The installation methods described in <xref linkend="cha-kvm-inst"/> can
      be used with SEV-SNP protected virtual machines. The only exception is ISO installation
      using a virtual CD-ROM. See the limitations section for more details.
    </para>

    <para>
      In addition to virtual CD-ROMs, &vmhost;-provided TPM devices are not compatible with
      AMD SEV-SNP-protected virtual machines and should be removed from the installation
      configuration. Rebooting SEV-SNP virtual machines is also not supported. The installation
      should ensure SEV-SNP virtual machines are configured to shut down on reboot. See the
      limitations section for more details.
    </para>
    <para>
      <xref linkend="sec-libvirt-inst-vmm"/> describes GUI-based virtual machine installation
      using virt-manager. To enable AMD SEV-SNP, activate <guilabel>Customize configuration before
      install</guilabel> before selecting <guilabel>Finish</guilabel> in the New VM wizard. When
      the &vmguest; configuration dialog opens, select <guilabel>Memory</guilabel>, then activate
      the <guilabel>Enable launch security</guilabel> checkbox and select <guilabel>Apply</guilabel>.
      Finally, select <guilabel>Begin Installation</guilabel> to proceed with the installation as
      described in <xref linkend="sec-libvirt-inst-vmm"/>.
    </para>

    <para>
      <xref linkend="sec-libvirt-inst-virt-install"/> describes virtual machine installation
      using <command>virt-install</command>. AMD SEV-SNP can be enabled with the
      <option>--launchSecurity</option> option. Below is a modification of
      <xref linkend="ex-libvirt-inst-virt-install-example"/> that enables AMD SEV-SNP protection:
    </para>
<screen>&prompt.user;virt-install --connect qemu:///system --virt-type kvm \
--name sle15sp7 --memory 4096 --disk size=60 --location /path/to/iso --graphics vnc \
--os-variant sle15sp7 --boot uefi --events on_reboot=destroy --launchSecurity type=sev-snp </screen>
    <para>
      See the <citetitle>Launch Security</citetitle> section of the libvirt
      <citetitle>Domain XML format</citetitle> manual at
      <link xlink:href="https://libvirt.org/formatdomain.html#launch-security"/>
      for more information on the settings supported by <option>--launchSecurity</option>.
    </para>
  </sect1>
  <sect1 xml:id="sec-vm-security-verify-vm">
    <title>AMD SEV-SNP 仮想マシンの確認</title>

    <para>仮想マシンの実行状態だけではコンフィデンシャル・コンピューティングが有効化されているかどうかがわかりません。代わりに仮想マシン内で確認する方法がいくつか提供されています。</para>

    <para>カーネルのログには、仮想マシン内での AMD メモリ暗号化機能に関するメッセージが出力されます。カーネルのログを確認するには、下記のようなコマンドを実行します:</para>

<screen>&prompt.sudo; <command>dmesg | grep -i sev-snp</command>
[ 1.986186] Memory Encryption Features active: AMD SEV SEV-ES SEV-SNP</screen>

    <para>カーネルログ内にメモリの暗号化機能として SEV-SNP が表示されていれば、コンフィデンシャル・コンピューティングが動作していて、仮想マシンに対してそれが有効化されていることがわかります。</para>

    <para>仮想マシン内から SEV-SNP 機能が有効化されているかどうかを確認したい場合は、任意でインストールできる <command>snpguest</command> ツールを使用します。 <command>snphost</command> ツールと同様に、 <command>snpguest</command> では MSR カーネルモジュールが必要となります。仮想マシン内でメモリ暗号化機能の状態を確認するには、下記のようなコマンドを実行します:</para>

<screen>&prompt.sudo; <command>modprobe msr &amp;&amp; snpguest ok</command>
[ PASS ] - SEV: ENABLED
[ PASS ] - SEV-ES: ENABLED
[ PASS ] - SNP: ENABLED
</screen>

    <para>AMD SEV-SNP 環境でセキュリティを証明するための、暗号方式として安全な方法もあります。</para>
  </sect1>

  <sect1 xml:id="sec-vm-security-snp-attestation">
    <title>AMD SEV-SNP 仮想マシンの認証</title>

    <para>SEV-SNP の有効化が確認できたら、あとは認証処理を行うことで仮想マシンの機密性を確立することができるようになります。この認証処理は暗号処理をベースにした認証で、階層構造による証明関係を構築することで、検証済みのファームウエアや TCB レベルを使用した、正規の AMD ハードウエアであることを証明します。</para>

    <para>なお、下記の手順ではローカルでの認証確認のみを実施することに注意してください。ゲスト内で生成されたレポート署名と証明書の連鎖を検証するとともに、認証データがプラットフォームの状態と一致していることを確認します。認証レポートを外部の検証器や検証サービスに送信して、プラットフォームの信頼性を独自に確認し、機密データや処理の認可を行うようなリモート認証は行いません。</para>

    <para>認証処理に際しては、 <command>snpguest</command> と <command>snphost</command> というツールを使用します。</para>

    <sect2 xml:id="sec-vm-security-snp-attestation-guest">
      <title>認証レポートの生成と検証</title>

       <para>ゲスト内で <command>snpguest</command> ツールを使用することで、認証ワークフローを実行することができます。この処理では認証レポートを生成し、それぞれの AMD 証明書の連鎖にアクセスして、正しいプラットフォーム鍵で電子的に署名されていることを検証します。</para>

      <procedure>
        <step>
          <para>まずは認証レポートと対応する要求ファイルを生成します。 <option>--random</option> フラグを指定することで、唯一性を保証するための乱数データを含めることができます:</para>
          <screen>&prompt.sudo;<command>snpguest report attestation-report.bin request-file.bin --random</command></screen>
        </step>

        <step>
          <para>次に鍵配布サービス (KDS) から AMD CA と ASK の各証明書を DER 形式で取得します。ここで、 <literal>genoa</literal> の箇所にはプロセッサモデルを指定します (モデルが異なる場合は変更してください):</para>
        <screen>&prompt.sudo;<command>snpguest fetch ca der genoa ./certs-kds</command></screen>
        </step>

        <step>
          <para>さらに生成された認証レポートを利用して、 Versioned Chip Endorsement Key (VCEK) を取得します:</para>
          <screen>&prompt.sudo;<command>snpguest fetch vcek der genoa ./certs-kds attestation-report.bin</command></screen>
        </step>

        <step>
          <para>取得した証明書を利用して、認証レポートを検証します:</para>
          <screen>&prompt.sudo;<command>snpguest verify attestation ./certs-kds attestation-report.bin</command>

Reported TCB Boot Loader from certificate matches the attestation report.
Reported TCB TEE from certificate matches the attestation report.
Reported TCB SNP from certificate matches the attestation report.
Reported TCB Microcode from certificate matches the attestation report.
Chip ID from certificate matches the attestation report.
VEK signed the Attestation Report!
          </screen>
        </step>
      </procedure>
    
      <note>
        <para>なお、 <command>snpguest certificates</command> コマンドを利用した拡張型の認証ワークフローは QEMU 側の機能に依存して動作するものですが、こちらは現時点では利用できません。</para>
      </note>
    </sect2>

    <sect2 xml:id="sec-vm-security-snp-attestation-host">
      <title>ホスト側での AMD 証明書の検証</title>
    <para>ホスト側では、必要に応じてゲスト側の認証レポートを検証するための AMD 証明書連鎖を取得および検証することができます。</para>

    <procedure>
        <step>
          <para>AMD 社の鍵配布サービス (KDS) から AMD CA と ASK の各証明書を取得します:</para>
<screen>&prompt.sudo; snphost fetch ca pem ./certs</screen>
        </step>

        <step>
          <para>次に、プラットフォームに対応した Chip Endorsement Certificate (VCEK または VLEK) を取得します:</para>
<screen>&prompt.sudo; snphost fetch vek pem ./certs</screen>
        </step>

        <step>
          <para>取得した証明書の連鎖の正当性を検証します:</para>
<screen>&prompt.sudo; <command>snphost verify ./certs</command>
• = self signed, ⬑ = signs, •̷ = invalid self sign, ⬑̸ = invalid signs

ARK •
ARK ⬑ ASK
ASK ⬑ VCEK
          </screen>
        </step>
      </procedure>
    </sect2>      
  </sect1>

  <sect1 xml:id="sec-vm-security-sev-snp-limits">
    <title>Current limitations</title>

    <para>
      The following limitations are placed on SEV-SNP &vmguest;s.
    </para>

    <itemizedlist>
      <listitem>
        <para>
          The guest operating system running inside an SEV-SNP protected VM must
          contain SEV-SNP support. &sls; 15 SP6 and newer releases support SEV-SNP.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s cannot be installed with <command>virt-install</command>
          via ISO using the <option>--cdrom</option> option. Use the <option>--location</option>
          instead. See the <command>virt-install</command> manual page for more information
          on the <option>--location</option> option.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s support a maximum of 255 vCPUs.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s are not compatible with Secure Boot. UEFI firmware
          containing Secure Boot support does not work with SEV-SNP &vmguest;s.
        </para>
      </listitem>
      <listitem>
	<para>
	  SEV-SNP protected &vmguest;s are not compatible with &vmhost;-provided TPM
	  devices. This includes emulated and passthrough TPM devices.
	</para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected Direct &vmguest;s do not support pass-through of host devices
	  (PCI passthrough).
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s do not support memory ballooning.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP protected &vmguest;s do not support memory or vCPU hotplugging.
        </para>
      </listitem>
      <listitem>
        <para>
          Using hugepages within a SEV-SNP protected &vmguest; is not supported.
        </para>
      </listitem>
      <listitem>
        <para>
          SEV-SNP &vmguest;s cannot be rebooted from within using <command>reboot</command>,
	  <command>shutdown -r now</command>, etc. A reboot must be done by shutting down the
	  &vmguest; and starting it again.
        </para>
      </listitem>
      <listitem>
        <para>
          Any operations that involve saving and restoring the memory and state of a
	  &vmguest; are currently not supported. This means that SEV-SNP protected
	  &vmguest;s cannot be resumed from snapshots, saved/restored or live migrated.
	  SEV-SNP protected &vmguest;s can be shut down and restarted on another host.
        </para>
      </listitem>
    </itemizedlist>

    <para>
      These limitations may be removed in the future as the hardware, firmware and specific
      layers of software receive new features.
    </para>
  </sect1>
</chapter>

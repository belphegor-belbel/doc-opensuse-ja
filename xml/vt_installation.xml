<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter [
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-vt-installation">
 <title>仮想化コンポーネントのインストール</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker>
   </dm:bugtracker>
  </dm:docmanager>
 </info>
 <para>実際に利用したい仮想化環境にもよりますが、インストール直後の状態では、必要な仮想化ツールが全くインストールされていません。必要なツールは、 &yast; モジュールの <menuchoice> <guimenu>仮想化</guimenu> <guimenu>ハイパーバイザとツールのインストール</guimenu></menuchoice> でハイパーバイザを設定することによって、インストールを行なうことができます。 &yast; 内に上記のモジュールが見つからない場合は、 <package>yast2-vm</package> パッケージをインストールしてください。</para>

 <sect1 xml:id="sec-vt-installation-kvm">
  <title>&kvm; のインストール</title>

  <para>&kvm; 本体や KVM ツールをインストールするには、下記の手順を実施します:</para>

  <procedure>
   <step>
    <para>まずは <package>yast2-vm</package> パッケージがインストールされていることを確認します。このパッケージは &yast; の設定ツールで、仮想化のハイパーバイザのインストールを簡略化することができるものです。</para>
   </step>
   <step>
    <para>&yast; を起動し、 <menuchoice> <guimenu>仮想化</guimenu> <guimenu>ハイパーバイザとツールのインストール</guimenu></menuchoice> を選択します。</para>
   </step>
   <step>
    <para><guimenu>&kvm; サーバ</guimenu> を選択すると、最小限の &qemu; ツールまでをインストールすることができます。 &libvirt; ベースの管理スタックも必要とする場合は、 <guimenu>&kvm; ツール</guimenu> も選択してください。選択が終わったら、 <guimenu>了解</guimenu> を押します。</para>
   </step>
   <step>
    <para>&vmguest; に対して通常のネットワーク機能を使用できるようにするには、ネットワークブリッジを設定する必要があります。 &yast; では &vmhost; の設定の際、自動的にブリッジを設定するように確認を表示します。通常は <guimenu>はい</guimenu> を押してそのまま進めてください。ネットワークが不要である場合は、 <guimenu>いいえ</guimenu> を押してもかまいません。</para>
   </step>
   <step>
    <para>インストールが終わったら、そのまま &vmguest; の設定を開始することができます。 &vmhost; の再起動は不要です。</para>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-xen">
  <title>&xen; のインストール</title>

  <para>&xen; 本体や &xen; ツールをインストールするには、下記の手順を実施します:</para>

  <procedure>
   <step>
    <para>&yast; を起動し、 <menuchoice> <guimenu>仮想化</guimenu> <guimenu>ハイパーバイザとツールのインストール</guimenu></menuchoice> を選択します。</para>
   </step>
   <step>
    <para><guimenu>&xen; サーバ</guimenu> を選択すると、最小限の &xen; ツールまでをインストールすることができます。 &libvirt; ベースの管理スタックも必要とする場合は、 <guimenu>&xen; ツール</guimenu> も選択してください。選択が終わったら、 <guimenu>了解</guimenu> を押します。</para>
   </step>
   <step>
    <para>&vmguest; に対して通常のネットワーク機能を使用できるようにするには、ネットワークブリッジを設定する必要があります。 &yast; では &vmhost; の設定の際、自動的にブリッジを設定するように確認を表示します。通常は <guimenu>はい</guimenu> を押してそのまま進めてください。ネットワークが不要である場合は、 <guimenu>いいえ</guimenu> を押してもかまいません。</para>
   </step>
   <step>
    <para>インストールが終わったらシステムを再起動します。起動時に <emphasis>&xen; カーネル</emphasis> を選択してください。</para>
    <tip>
     <title>既定の起動カーネルについて</title>
     <para>全ての機能が期待通りに動作することを確認したら、 &yast; を利用して既定で起動するカーネルを変更し、 &xen; を有効化したカーネルを使用するようにしてください。既定のカーネルを変更する方法については、 <xref linkend="sec-grub2-yast2-config"/> をお読みください。</para>
    </tip>
   </step>
  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-containers">
  <title>コンテナのインストール</title>

  <para>コンテナをインストールするには、下記の手順を実施します:</para>

  <procedure>
   <step>
    <para>&yast; を起動し、 <menuchoice> <guimenu>仮想化</guimenu> <guimenu>ハイパーバイザとツールのインストール</guimenu></menuchoice> を選択します。</para>
   </step>
   <step>
    <para><guimenu>libvirt LXC デーモン</guimenu> を選択して、 <guimenu>了解</guimenu> を押します。</para>
   </step>
<!-- ========================================================= -->
<!-- TODO Either fix Yast to reload apparmor or describe it here -->
<!-- ========================================================= -->
  </procedure>
 </sect1>
 <sect1 xml:id="sec-vt-installation-patterns">
  <title>パターン</title>

  <para>Zypper を利用してパターンを選択することで、仮想化パッケージをインストールすることもできます。 <command>zypper in -t pattern</command> <replaceable>パターン名</replaceable> のように入力して実行してください。利用可能なパターン名は下記のとおりです:</para>

  <variablelist>
   <varlistentry>
    <term>KVM</term>
    <listitem>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para><systemitem class="resource">kvm_server</systemitem> : &kvm; の &vmhost; と、管理用の &qemu; ツールをインストールします。</para>
      </listitem>
      <listitem>
       <para><systemitem class="resource">kvm_tools</systemitem> : &vmguest; を管理したり監視したりするための、 &libvirt; ツールをインストールします。</para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Xen</term>
    <listitem>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para><systemitem class="resource">xen_server</systemitem> : &xen; の &vmhost; と、管理用の &xen; ツールをインストールします。</para>
      </listitem>
      <listitem>
       <para><systemitem class="resource">xen_tools</systemitem> : &vmguest; を管理したり監視したりするための、 &libvirt; ツールをインストールします。</para>
      </listitem>
     </itemizedlist>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>コンテナ</term>
    <listitem>
     <para>コンテナ向けにはパターンが提供されていません。 <emphasis>libvirt-daemon-lxc</emphasis> パッケージをインストールしてください。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>

 <sect1 xml:id="sec-vt-installation-ovmf">
  <title>UEFI サポートのインストール</title>
  <para>UEFI への対応は <emphasis>OVMF</emphasis> ( <emphasis>Open Virtual Machine Firmware</emphasis> ) で提供されています。 UEFI での起動を有効化するには、まず <package>qemu-ovmf-x86_64</package> もしくは <package>qemu-uefi-aarch64</package> パッケージをインストールしてください。</para>
  <para>&libvirt; は既定の UEFI ファームウエアおよび VARS イメージとして、 <filename>/usr/share/qemu/ovmf-x86_64-ms-4m-code.bin</filename> と <filename>/usr/share/qemu/ovmf-x86_64-ms-4m-vars.bin</filename> を使用するように設定されています。 &arm; の場合、既定は <filename>/usr/share/qemu/aavmf-aarch64-code.bin</filename> と <filename>/usr/share/qemu/aavmf-aarch64-vars.bin</filename> になります。</para>
  <para>パッケージには下記のファイルが含まれています:</para>
<screen>&prompt.root;<command>rpm -ql qemu-ovmf-x86_64</command>
/usr/share/qemu/ovmf-x86_64-ms-code.bin
/usr/share/qemu/ovmf-x86_64-ms-vars.bin
/usr/share/qemu/ovmf-x86_64-ms.bin
/usr/share/qemu/ovmf-x86_64-opensuse-code.bin
/usr/share/qemu/ovmf-x86_64-opensuse-vars.bin
/usr/share/qemu/ovmf-x86_64-opensuse.bin
/usr/share/qemu/ovmf-x86_64-suse-code.bin
/usr/share/qemu/ovmf-x86_64-suse-vars.bin
/usr/share/qemu/ovmf-x86_64-suse.bin
/usr/share/qemu/ovmf-x86_64-code.bin
/usr/share/qemu/ovmf-x86_64-vars.bin
/usr/share/qemu/ovmf-x86_64.bin</screen>
  <para><filename>*-code.bin</filename> ファイルは UEFI ファームウエアです。 <filename>*-vars.bin</filename> ファイルは対応する変数ストアイメージで、 VM ごとの不揮発性ストア向けのテンプレートとして使用できるファイルです。 &libvirt; は VM を初めて作成する際、指定された <literal>vars</literal> テンプレートを VM ごとのパス (<filename>/var/lib/libvirt/qemu/nvram/</filename>) にコピーします。なお、ファイル名の中に <literal>code</literal> や <literal>vars</literal> を含まないファイルは、単独の UEFI イメージとして使用することができます。これらは VM のシャットダウン後には UEFI 変数が維持されない仕組みであることから、有用ではありません。</para>
  <para><filename>*-ms*.bin</filename> ファイルには、実際のハードウエア内に存在する Microsoft 社の鍵が含まれています。そのため、これらは &libvirt; の既定で設定されるようになっています。同様に、 <filename>*-suse*.bin</filename> ファイルには、事前にインストールされる &suse; や &opensuse; の鍵が含まれています。事前にインストールされる鍵の無いファイルも提供されています。</para>
  <para>詳しくは <xref linkend="vle-libvirt-inst-virt-install-ovmf"/> と <link xlink:href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt"/> (英語) をお読みください。</para>
 </sect1>
 <sect1 xml:id="sec-vt-installation-nested-vms">
  <title>Enable Support for Nested Virtualization in &kvm;</title>

  <important>
   <title>Technology Preview</title>
   <para>
    &kvm;'s nested virtualization is still a technology preview. It is provided
    for testing purposes and is not supported.
   </para>
  </important>

  <para>
   Nested guests are &kvm; guests run in a &kvm; guest. When describing nested
   guests, we will use the following virtualization layers:
  </para>

  <variablelist>
   <varlistentry>
    <term>L0</term>
    <listitem>
     <para>
      A bare metal host running &kvm;.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>L1</term>
    <listitem>
     <para>
      A virtual machine running on L0. Because it can run another &kvm;, it is
      called a <emphasis>guest hypervisor</emphasis>.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>L2</term>
    <listitem>
     <para>
      A virtual machine running on L1. It is called a <emphasis>nested
       guest</emphasis>.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

  <para>
   Nested virtualization has many advantages. You can benefit from it in the
   following scenarios:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Manage your own virtual machines directly with your hypervisor of choice in
     cloud environments.
    </para>
   </listitem>
   <listitem>
    <para>
     Enable the live migration of hypervisors and their guest virtual machines
     as a single entity.
    </para>
   </listitem>
   <listitem>
    <para>
     Use it for software development and testing.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   To enable nesting temporarily, remove the module and reload it with the
   <option>nested</option> &kvm; module parameter:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     For Intel CPUs, run:
    </para>
<screen>
&prompt.sudo;modprobe -r kvm_intel &amp;&amp; modprobe kvm_intel nested=1
</screen>
   </listitem>
   <listitem>
    <para>
     For AMD CPUs, run:
    </para>
<screen>
&prompt.sudo;modprobe -r kvm_amd &amp;&amp; modprobe kvm_amd nested=1
</screen>
   </listitem>
  </itemizedlist>

  <para>
   To enable nesting permanently, enable the <option>nested</option> &kvm;
   module parameter in the <filename>/etc/modprobe.d/kvm_*.conf</filename> file,
   depending on your CPU:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     For Intel CPUs, edit <filename>/etc/modprobe.d/kvm_intel.conf</filename>
     and add the following line:
    </para>
    <screen>options kvm_intel nested=Y</screen>
   </listitem>
   <listitem>
    <para>
     For AMD CPUs, edit <filename>/etc/modprobe.d/kvm_amd.conf</filename> and
     add the following line:
    </para>
    <screen>options kvm_amd nested=Y</screen>
   </listitem>
  </itemizedlist>

  <para>
   When your L0 host is capable of nesting, you will be able to start an L1
   guest with one of the following ways:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     Use the <option>-cpu host</option> &qemu; command line option.
    </para>
   </listitem>
   <listitem>
    <para>
     Add the <literal>vmx</literal> (for Intel CPUs) or the
     <literal>svm</literal> (for AMD CPUs) CPU feature to the
     <option>-cpu</option> &qemu; command line option, which enables
     virtualization for the virtual CPU.
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter [
<!ENTITY % entities SYSTEM "generic-entities.ent">
%entities;
]>
<!--PM's doc requirements:
*  Server based automounting of home directories
1.Configuration and usage description (m)
2.Firewall configuration for SMB support (m)
3.Kerberos support description (d)
This is related to #300967: Mount Server Home Directory Automatically with
Authentication.  Everything that's being done there to ensure that the users
will be able to access their home directories when hosted on CIFS.
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-samba">
 <title>Samba</title>
 <info>
  <abstract>
   <para>Samba を使用することで、 Unix マシンを MacOS や Windows, OS/2 マシンに対するファイルサーバや印刷サーバに仕立て上げることができます。 Samba は今や本格的な使用にも耐える複雑な製品になっています。 Samba の設定は &yast; で行うことができるほか、設定ファイルを手作業で修正して設定することもできます。</para>
  </abstract>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>
 <important>
  <title>SMB1 will be disabled</title>
  <para>
   Starting with Samba version 4.17, the SMB1 protocol has been disabled in
   &slea; and is not no longer supported.
  </para>
 </important>
 <sect1 xml:id="sec-samba-term">
  <title>用語</title>

  <para>Samba の文書や &yast; のモジュールでは、それぞれ下記のような用語を使用します。</para>

  <variablelist>
   <varlistentry>
    <term>SMB プロトコル</term>
    <listitem>
     <para>Samba では <phrase role="productname">NetBIOS</phrase> サービスをベースにした SMB (Server Message Block) というプロトコルを使用しています。 Microsoft 社はソフトウエアの製造元に向けてプロトコルを公開しているため、他のオペレーティングシステムからでも Microsoft のオペレーティングシステムに接続できるようになっています。なお、 Samba では SMB プロトコルを TCP/IP プロトコル上で動作させていることから、 Samba に接続するクライアントには TCP/IP プロトコルをインストールしておかなければなりません。</para>
     <tip arch="zseries" os="sles">
      <title>&zseries;: NetBIOS のサポートについて</title>
      <para>&zseries; では SMB over TCP/IP のみに対応しています。これらのシステムでは、 NetBIOS へのサポートはご利用いただけません。</para>
     </tip>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>CIFS プロトコル</term>
    <listitem>
     <para>CIFS (Common Internet File System) プロトコルは SMB1 としても知られているプロトコルで、 SMB プロトコルの初期のバージョンです。 CIFS は TCP/IP を介して遠隔のファイルシステムにアクセスするためのプロトコルを規定していて、共同作業のグループを作成したり、ネットワークを介して文書を共有したりすることができます。</para>
     <para>なお、 SMB1 は Microsoft Windows Vista&trade; 以降で提供されるようになった SMB2 に取って代わられています。その後、 Microsoft Windows 8&trade; と Microsoft Windows Server 2012 では SMB3 が提供されるようになっています。なお、最近のバージョンの Samba では、セキュリティ上の理由から、 SMB1 は無効化されています。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>NetBIOS</term>
    <listitem>
     <para><phrase role="productname">NetBIOS</phrase> はネットワーク内でのコンピュータ同士の名前解決や通信を行うために設計されたソフトウエアインターフェイス (API) です。 NetBIOS は、まず自分自身の名前を、接続されているネットワーク内で予約する処理を行います。予約が完了すると、それらのマシン間は名前で通信できるようになります。名前を管理するための中央サーバのような仕組みは存在せず、ネットワーク内で既に使用されている場合を除いて、任意の名前を予約することができます。 NetBIOS のインターフェイスは、様々なネットワークプロトコルに対応していますが、そのうちの比較的シンプルな実装として、 <phrase role="productname">NetBEUI</phrase> と呼ばれるルーティングに対応していないプロトコルが存在しています (これは NetBIOS API とよく混同される存在でもあります) 。NetBIOS は Novell 社提供の IPX/SPX プロトコルでも利用されていますが、 Samba のバージョン 3.2 以降では IPv4 および IPv6 上での NetBIOS に対応しています。</para>
     <para>TCP/IP で送信される NetBIOS のホスト名は、 <filename>/etc/hosts</filename> や DNS で管理される名前とは無関係に動作します。 NetBIOS では、独自の独立した名前付け規約が存在しています。ただし、 DNS のホスト名と NetBIOS の名前を一致させておくことで、管理上の混乱を避けることをお勧めします。 Samba でも、特に指定のない限り、 DNS 名と NetBIOS の名前は一致するように動作します。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba サーバ</term>
    <listitem>
     <para>Samba サーバは SMB/CIFS サービスや NetBIOS over IP のホスト名管理サービスを、クライアントに対して提供する仕組みです。 Linux では、 Samba サーバは SMB/CIFS サービスを提供する <literal>smbd</literal> 、ホスト名管理サービスを提供する <literal>nmbd</literal> 、そして認証機能を提供する <literal>winbind</literal> の 3 つから構成されています。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Samba クライアント</term>
    <listitem>
     <para>Samba クライアントは、 SMB プロトコルを介して Samba サーバが提供するサービスを使用するシステムを意味します。 Windows や MacOS などの一般的なオペレーティングシステムが SMB プロトコルに対応しています。なお、 TCP/IP プロトコルも全てのコンピュータにインストールしておかなければなりません。 Samba は様々な Unix 系オペレーティングシステムに対して、クライアント機能を提供しています。 Linux の場合は、 Linux のシステムレベルで SMB の資源を利用することができるよう、 SMB 向けのカーネルモジュールが用意されています。そのため、 Samba クライアント側では、デーモンを動作させる必要がありません。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>共有</term>
    <listitem>
     <para>SMB サーバは、 <emphasis>共有</emphasis> と呼ばれるものを介してクライアントに資源を提供します。共有はサーバ内の特定のディレクトリ (およびそれ以下のディレクトリ) を表すものであるほか、プリンタを表す場合もあります。また、共有には <emphasis>共有名</emphasis> を付けて公開し、名前でアクセスを行います。共有名には任意の名前を付けることができ、ディレクトリ名と必ずしも一致する必要はありません。また、プリンタについても名前を設定します。クライアント側からは名前でプリンタにアクセスします。</para>
     <para>また、共有名がドル記号 ( <literal>$</literal> ) で終わるものは隠し共有として扱われます。このような共有は Windows コンピュータから共有名を参照した場合、一覧表示には現れないものになります。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>DC</term>
    <listitem>
     <para>ドメインコントローラ (DC) は、ドメイン内のアカウントを処理するサーバです。データを複製する目的で、 1 つのドメイン内に複数のドメインコントローラを設置することもあります。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-samba-server-sled" os="sled">
  <title>Samba サーバのインストール</title>

  <para>Samba サーバのインストールは &sled; ではサポートしていません。 Samba サーバのインストールと設定について、詳しくは &sls; 向けの &admin; をお読みください。</para>
 </sect1>
 <sect1 xml:id="sec-samba-install" os="sles;osuse">
  <title>Samba サーバのインストール</title>

  <para>Samba サーバをインストールするには、 &yast; を起動して <menuchoice><guimenu>ソフトウエア</guimenu> <guimenu>ソフトウエア管理</guimenu></menuchoice> を選択し、表示されたウインドウ内で <menuchoice><guimenu>表示</guimenu> <guimenu>パターン</guimenu></menuchoice> を選んで <guimenu>ファイルサーバ</guimenu> を選択します。あとは <guimenu>了解</guimenu> を押して必要なパッケージをインストールします。</para>
 </sect1>
 <sect1 xml:id="sec-samba-serv-start" os="sles;osuse">
  <title>Samba の開始と停止</title>

  <para>Samba サーバは、システムの起動時に自動的に開始することができるほか、手作業で開始するように設定することができます。開始と停止のポリシーは、 <xref linkend="sec-samba-yast2-conf"/> で説明しているとおり、 &yast; の Samba サーバ設定内で指定することができます。</para>

  <para>コマンドラインから Samba サービスを停止するには、 <command>systemctl stop smb nmb</command> を実行します。 Samba サービスを開始するには、 <command>systemctl start nmb smb</command> を実行します。 <literal>smb</literal> サービスを開始することで、 <literal>winbind</literal> も必要に応じて自動的に開始されます。</para>

  <tip>
   <title><systemitem>winbind</systemitem></title>
   <para><systemitem>winbind</systemitem> は個別のサービスとして提供されているもので、パッケージとしても <systemitem>samba-winbind</systemitem> という別の名前のパッケージになっています。</para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-serv-inst" os="sles;osuse">
  <title>Samba サーバの設定</title>

  <para>&productnamereg; 内での Samba サーバは、 2 種類の異なる方法で設定することができます。 1 つは &yast; を利用する方法、もう 1 つは手作業で設定する方法です。手作業で設定を行うことで、より細かい設定を行いことができますが、 &yast; GUI ほどの利便性はありません。</para>

  <sect2 xml:id="sec-samba-yast2-conf">
   <title>&yast; を利用した Samba サーバの設定</title>
   <para>Samba サーバを設定するには、 &yast; を起動して <menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>Samba サーバ</guimenu></menuchoice> を選択します。</para>
   <sect3 xml:id="sec-samba-yast2-conf-inst">
    <title>Samba の初期設定</title>
    <para>初めてモジュールを起動した場合は、 <guimenu>Samba インストール</guimenu> のダイアログが表示され、サーバの管理に関わる基本的な設定を行うことができます。また設定の最後では、 Samba の管理者パスワード (<guimenu>Samba の管理者 (root) パスワード</guimenu>) を入力します。 2 回目以降のモジュール起動では、 <guimenu>Samba の設定</guimenu> ダイアログが表示されます。</para>
    <para><guimenu>Samba インストール</guimenu> ダイアログは 2 つの手順から構成され、必要であれば詳細な設定を行うことができるようになっています:</para>
    <variablelist>
     <varlistentry>
      <term>ワークグループまたはドメイン名</term>
      <listitem>
       <para><guimenu>ワークグループまたはドメイン名</guimenu> では、新しいワークグループまたはドメインの名前、もしくは既存の名前を選択して <guimenu>次へ</guimenu> を押します。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Samba サーバの種類</term>
      <listitem>
       <para>次の手順では、サーバをプライマリドメインコントローラ (PDC) として動作させるか、もしくはバックアップドメインコントローラ (BDC) として動作させるか、もしくはドメインコントローラとして動作させないようにするかを選択することができます。選択を行ったら <guimenu>次へ</guimenu> を押します。</para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>詳細なサーバ設定を行いたくない場合は、 <guimenu>OK</guimenu> を押してそのまま閉じてください。最後に表示されたポップアップボックスで <guimenu>Samba の管理者 (root) パスワード</guimenu> を入力します。</para>
    <para>全ての設定は、 <guimenu>Samba の設定</guimenu> ダイアログ内で後から変更することができます。ダイアログには <guimenu>起動</guimenu> , <guimenu>共有</guimenu> , <guimenu>識別情報</guimenu> , <guimenu>信頼するドメイン</guimenu> , <guimenu>LDAP の設定</guimenu> の各タブが用意されています。</para>
   </sect3>
   <sect3 xml:id="sec-samba-server-new-protocol">
    <title>サーバ側における最新バージョンの SMB サーバへの対応について</title>
    <para>最新バージョンの &productname; やその他の最新 Linux ディストリビューションをお使いの場合、安全性の低い SMB1/CIFS プロトコルが既定で無効化されています。しかしながら、既存の Samba サーバの場合、 SMB1 プロトコルのみを使用するように構成されているものも存在しています。このようなサーバに接続しているクライアントに対応するには、少なくとも SMB 2.1 プロトコルに対応できるように設定する必要があります。</para>
    <para>環境によっては SMB1 プロトコルのみを使用できるものもあります。たとえば SMB1 や CIFS の Unix 拡張に依存して動作しているような場合です。これらの拡張は新しいバージョンのプロトコルには移植されていませんので、そのような環境をお持ちの場合は、環境を変更するか、もしくは <xref linkend="sec-samba-client-old-server"/> をお読みください。</para>
    <para>SMB 2.1 プロトコルに対応するよう設定するには、 <filename>/etc/samba/smb.conf</filename> ファイル内のグローバルパラメータに <literal>server max protocol = SMB2_10</literal> を設定します。設定可能な値の一覧について、詳しくは <command>man smb.conf</command> をお読みください。</para>
   </sect3>
   <sect3 xml:id="sec-samba-yast2-conf-adv">
    <title>高度な Samba の設定</title>
    <para>Samba サーバモジュールを初めて起動した場合も、初回起動時の設定を行うと、 <xref linkend="sec-samba-yast2-conf-inst"/> にあるとおりの <guimenu>Samba の設定</guimenu> ダイアログが表示されるようになります。ここから Samba サーバの設定を変更することができます。</para>
    <para>設定の変更が終わったら、 <guimenu>OK</guimenu> を押すと設定を保存することができます。</para>
    <sect4 xml:id="sec-samba-yast2-conf-adv-start">
     <title>サーバの開始</title>
     <para><guimenu>開始</guimenu> タブでは、 Samba サーバの開始方法を設定することができます。システムの起動時にサービスを開始するように設定するには、 <guimenu>システム起動時</guimenu> を選択します。手作業で開始するように設定するには、 <guimenu>手動</guimenu> を選択します。 Samba サーバの開始に関する詳細は、 <xref linkend="sec-samba-serv-start"/> をお読みください。</para>
     <para>このタブでは、ファイアウオールのポートを開く作業を行うこともできます。ポートを開くには、 <guimenu>ファイアウオールでポートを開く</guimenu> を選択します。複数のネットワークインターフェイスを接続している場合は、 <guimenu>ファイアウオールの詳細</guimenu> を押して、 Samba サービスを提供するネットワークインターフェイスを選択することができます。インターフェイスを選択したら <guimenu>OK</guimenu> を押して閉じてください。</para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-shares">
     <title>共有</title>
     <para><guimenu>共有</guimenu> タブでは、有効にする Samba の共有を選択することができます。なお、 homes や printers のように、いくつかの事前設定が用意されています。共有を選択して <guimenu>状態切り替え</guimenu> を押すことで、 <guimenu>有効</guimenu> と <guimenu>無効</guimenu> の間を切り替えることができます。また、新しい共有を追加するには <guimenu>追加</guimenu> を、選択した共有を削除するには <guimenu>削除</guimenu> を押します。</para>
     <para>ユーザが独自にディレクトリを指定して共有できるようにするには、 <guimenu>ユーザにディレクトリの共有を許可する</guimenu> を選択し、 <guimenu>許可するグループ</guimenu> 内に共有の設定を許可するグループを指定します。たとえば <systemitem>users</systemitem> のように指定した場合はローカルのグループを、 <systemitem>ドメイン\ユーザ</systemitem> のように指定した場合はドメインのグループを指定することができます。また、共有を設定するには、ファイルシステム側のアクセス権で許可しておかなければならないことにも注意してください。このほか、 <guimenu>最大共有数</guimenu> を指定することで、作成することのできる共有数の最大値を制限することができます。認証を行わずにユーザの作成した共有にアクセスできるようにするには、 <guimenu>ゲストアクセスを許可</guimenu> を選択してください。</para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-identity">
     <title>識別情報</title>
     <para><guimenu>識別情報</guimenu> タブでは、ホストの所属するドメイン (<guimenu>基本設定</guimenu>) やネットワーク内での代替ホスト名の使用 (<guimenu>NetBIOS ホスト名</guimenu>) を設定することができます。 <!-- [x] Retrieve WINS server via DHCP [ ] Use WINS for Hostname Resolution--> このほか、名前解決に対して Microsoft Windows Internet Name Service (WINS) を使用するよう設定することもできます。この場合は、 <guimenu>ホスト名の解決に WINS を使用する</guimenu> を選択し、 <guimenu>DHCP で WINS サーバのアドレスを取得</guimenu> を必要に応じて選択してください。 <phrase os="sles;osuse">TDB データベースではなく LDAP を使用するような場合など、</phrase> より高度なグローバル設定やユーザ認証設定を行いたい場合は、 <guimenu>詳細設定</guimenu> を押します。</para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-trusted">
     <title>信頼するドメイン</title>
     <para>他のドメインのユーザがお使いのドメインにアクセスできるようにするには、 <guimenu>信頼するドメイン</guimenu> のタブで適切な設定を行います。新しいドメインを追加するには <guimenu>追加</guimenu> を押します。選択したドメインを削除するには <guimenu>削除</guimenu> を押します。</para>
    </sect4>
    <sect4 xml:id="sec-samba-yast2-conf-adv-ldap">
     <title>LDAP の設定</title>
     <para><guimenu>LDAP 設定</guimenu> のタブでは、認証時に LDAP のサーバを使用するように設定することができます。 LDAP サーバとの通信をテストするには、 <guimenu>接続のテスト</guimenu> を押します。より高度な設定や既定値の設定を行うには、 <guimenu>詳細設定</guimenu> を押します。</para>
     <para>LDAP の設定に関する詳細は、 <xref linkend="cha-security-ldap"/> をお読みください。</para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 xml:id="sec-samba-serv-inst-manual">
   <title>手作業によるサーバの設定</title>
   <para>Samba をサーバとして使用したい場合は、 <systemitem class="resource">samba</systemitem> をインストールしてください。 Samba のメインの設定ファイルは <filename>/etc/samba/smb.conf</filename> です。このファイルは論理的に 2 つのパートから構成されていて、 <literal>[global]</literal> セクションには全体的な設定が含まれています。また、下記の既定のセクションには、個別のファイルおよびプリンタの共有が含まれています:</para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>[homes]</para>
    </listitem>
    <listitem>
     <para>[profiles]</para>
    </listitem>
    <listitem>
     <para>[users]</para>
    </listitem>
    <listitem>
     <para>[groups]</para>
    </listitem>
    <listitem>
     <para>[printers]</para>
    </listitem>
    <listitem>
     <para>[print$]</para>
    </listitem>
   </itemizedlist>
   <para>このような構造になっていることから、共有に対する設定は個別に行うことができるだけでなく、 <literal>[global]</literal> セクションで一括に設定することもできるようになっています。これにより、設定ファイルを読みやすくしています。</para>
   <sect3 xml:id="sec-samba-smb-conf-Erlaeuterung">
    <title>global セクション</title>
    <para><literal>[global]</literal> セクション内の下記のパラメータは、お使いのネットワーク環境や要件に応じて、修正する必要があります。これにより、 Windows 環境の他のマシンから、お使いの Samba サーバにアクセスすることができるようになります。</para>
    <remark>ke: Important entries missing?</remark>
    <variablelist>
     <varlistentry>
      <term><literal>workgroup = WORKGROUP</literal></term>
      <listitem>
       <para>この行は、 Samba サーバをワークグループに割り当てる設定です。 <literal>WORKGROUP</literal> の箇所は、お使いのネットワーク環境に合わせて設定してください。また、お使いの Samba サーバは、ネットワーク内に同じ名前のものが存在していない限り、 DNS ホスト名でアクセスすることができます。ホスト名が利用できない場合は、 <literal>netbiosname=<replaceable>ホスト名</replaceable></literal> を指定して対応することもできます。このパラメータについて、詳しくは <systemitem>smb.conf</systemitem> のマニュアルページをお読みください。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>os level = 20</literal></term>
      <listitem>
       <para>このパラメータは、お使いの Samba サーバがワークグループ内の LMB (ローカルマスタブラウザ; Local Master Browser) になるかどうかを設定するものです。 <literal>2</literal> のように非常に小さい値を設定すると、もしも Samba サーバの設定を誤っていても、既存の Windows ネットワークに悪影響を及ぼさないようにすることができます。この設定値に関する詳細は、 Samba 3 Howto の Network Browsing 章をお読みください。 Samba 3 Howto については <xref linkend="sec-samba-info"/> をご覧ください。</para>
       <para>他の SMB サーバ (Windows 2000 Server など) がネットワーク内に存在しない場合で、お使いの Samba サーバに対してローカル環境内に存在するコンピュータの管理を行わせたい場合は、 <literal>os level</literal> の値をより大きく (例: <literal>65</literal>) してください。これにより、 Samba サーバがローカルネットワーク内の LMB として動作するようになります。</para>
       <para>この設定を変更する場合は、既存の Windows ネットワーク環境に対してどのような影響が発生しうるのかをよくお確かめください。可能の限り、個別の環境を構築してテストするか、業務上の影響がない日を選んで設定してください。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><literal>wins support</literal> および <literal>wins server</literal></term>
      <listitem>
       <para>お使いの Samba サーバを WINS サーバのある Windows ネットワークに接続するには、 <option>wins server</option> オプションを追加して、 WINS サーバのアドレスを指定してください。</para>
       <para>もしもお使いの Windows マシンが異なるサブネット内に存在している環境で、 Samba サーバとの間で相互に通信を行う必要がある場合も、 WINS サーバを設定する必要があります。 Samba サーバを WINS サーバとしても動作させるには、 <literal>wins support = Yes</literal> を設定してください。ただし、ネットワーク内の 1 台のみで、この設定を有効化してください。また、 <literal>wins server</literal> と <literal>wins support</literal> は、同じ <filename>smb.conf</filename> ファイル内で同時に設定してはなりません。</para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   <sect3 xml:id="sec-samba-smb-conf-shares">
    <title>共有</title>
    <para>下記の例では、 CD-ROM ドライブとユーザのホームディレクトリ ( <literal>homes</literal> ) を、 SMB クライアントに対して公開する設定を示しています。</para>
    <variablelist>
     <varlistentry>
      <term>[cdrom]</term>
      <listitem>
       <para>CD-ROM ドライブが意図せずに公開されてしまうことを防ぐため、これらの行は行頭にコメント文字 (この場合はセミコロン) を追加して無効化されています。 Samba で CD-ROM ドライブを共有するには、行頭のセミコロンを削除してください。</para>
       <example xml:id="dat-cd-rom">
        <title>CD-ROM ドライブの共有</title>
<screen>[cdrom]
       comment = Linux CD-ROM
       path = /media/cdrom
       locking = No</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term><option>[cdrom]</option> と <option>comment</option></term>
         <listitem>
          <para><literal>[cdrom]</literal> では、ネットワーク内で全ての SMB クライアントに対して表示される、共有名を設定しています。また、 <literal>comment</literal> 以下の値はコメント欄で、共有に関するより詳しい説明文を設定します。</para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>path = /media/cdrom</option></term>
         <listitem>
          <para><option>path</option> の指定を行うことで、指定したディレクトリ (この場合は <filename>/media/cdrom</filename>) を公開することになります。</para>
         </listitem>
        </varlistentry>
       </variablelist>
       <para>既定の設定は非常に限定された構成になっているため、この種類の共有は、このシステム内に存在するユーザにのみ提供されます。この共有を誰にでも利用できるようにするには、設定内に <literal>guest ok = yes</literal> を追加してください。この設定により、ネットワーク内の誰にでも読み込むことができるようになります。ただし、このパラメータはよく注意してお使いください。また、このパラメータは <literal>[global]</literal> セクション内でも設定することができます。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><option>[homes]</option></term>
      <listitem>
       <para><option>[homes]</option> の共有は、ここでは特別な意味があります。 Linux ファイルサーバ内にアカウントとパスワードが存在し、ホームディレクトリが存在するユーザであれば、そのホームディレクトリに接続できるようになります。</para>
       <example xml:id="dat-homes-frei">
        <title>[homes] 共有</title>
<screen>[homes]
        comment = Home Directories
        valid users = %S
        browseable = No
        read only = No
        inherit acls = Yes</screen>
       </example>
       <variablelist>
        <varlistentry>
         <term>[homes]</term>
         <listitem>
          <para>SMB サーバに接続するユーザ名と同じ名前の共有が存在する場合を除き、 <literal>[homes]</literal> では動的に共有が生成されます。生成される共有名は、ユーザ名と同じになります。</para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>valid users = %S</option></term>
         <listitem>
          <para><literal>%S</literal> は Samba サーバとの接続が確立した際に、共有の名前に置き換えられる項目です。 <option>[homes]</option> セクションでこれを指定した場合は、ユーザ名に置き換えられます。そのため、ユーザ名と同じ名前の共有は、そのユーザでのみアクセスすることができます。</para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>browseable = No</option></term>
         <listitem>
          <para>この設定は、ネットワーク環境内では表示を行わないようにする設定です。</para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>read only = No</option></term>
         <listitem>
          <para>既定では、 Samba は <literal>read only = Yes</literal> パラメータと同じ効力になっていて、公開された共有への書き込みを禁止しています。この共有に対する書き込みを許可するには、 <literal>read only = No</literal> を設定してください。なお、 <literal>writable = Yes</literal> でも同じ意味になります。</para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><option>create mask = 0640</option></term>
         <listitem>
          <para>MS Windows NT ベースではないシステムの場合、 Unix のアクセス権 (パーミッション) に相当する考え方はなく、ファイルを作成する際にもアクセス権を設定することができません。 <literal>create mask</literal> パラメータでは、新しく作成したファイルに対して割り当てるアクセス権を指定します。この設定は書き込みのできる共有に対してのみ適用されます。そのため、上記の設定を行うと、所有者が読み込みと書き込みの権限を、所有者のプライマリグループに属するユーザが読み込みの権限を持つようになります。ただし、 <option>valid users = %S</option> という設定が存在しているため、グループに対して読み込みアクセスを許可していても、実際にはアクセスができなくなります。グループに対して読み込みや書き込みのアクセスを許可するには、 <option>valid users = %S</option> の行を無効化してください。</para>
         </listitem>
        </varlistentry>
       </variablelist>
      </listitem>
     </varlistentry>
    </variablelist>
    <warning>
     <title>Samba における <literal>NFS</literal> マウントの共有設定について</title>
     <para><literal>NFS</literal> でマウントされているディレクトリは、 Samba で共有してしまうとデータの損失が発生する可能性がありますので、サポート対象外となります。対象のファイルが存在するサーバで直接 Samba を動作させるか、 <literal>iSCSI</literal> などをお使いください。</para>
    </warning>
   </sect3>
   <sect3 xml:id="sec-samba-rechte">
    <title>セキュリティレベル</title>
    <para>セキュリティを強化する目的で、それぞれの共有にはパスワードを設定して保護することができます。 SMB では、アクセス許可を確認するための様々な方法が用意されています:</para>
    <variablelist>
     <varlistentry>
      <term>ユーザレベルセキュリティ ( <literal>security = user</literal> )</term>
      <listitem>
       <para>この設定は、 SMB に対してユーザの考え方を導入します。各ユーザはサーバに対して、あらかじめ登録を行ってパスワードを設定する必要があります。登録完了後は、設定したユーザ名に従って個別にアクセスを許可するようになります。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ADS レベルセキュリティ ( <literal>security = ADS</literal> )</term>
      <listitem>
       <para>このモードでは、 Samba を Active Directory 環境内のドメインメンバーとして動作させます。このモードでは、 Samba サーバ内に Kerberos をインストールして設定しておく必要があります。また、 Samba サーバは ADS の領域内に参加させておく必要もあります。 ADS への参加は、 &yast; の <guimenu>Windows ドメインメンバーシップ</guimenu> モジュールで実施することができます。</para>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>ドメインレベルセキュリティ ( <literal>security = domain</literal> )</term>
      <listitem>
       <para>このモードは、 Samba サーバを Windows ドメインに参加させた場合にのみ正しく動作します。 Samba は指定されたユーザ名とパスワードを、 Windows NT Server のメンバーサーバと同様に、 Windows のプライマリもしくはバックアップドメインコントローラに送信して認証作業を行うようになります。また、このモードではパスワードの暗号化を <literal>yes</literal> に設定する必要があります。</para>
      </listitem>
     </varlistentry>
    </variablelist>
    <para>上記のユーザレベル、 ADS レベル、ドメインレベルのセキュリティ設定は、サーバ全体に対して適用されます。一方の共有をユーザレベルに、他方の共有を ADS レベルに、などの設定を行うことはできません。しかしながら、システムに複数の IP アドレスが設定されていれば、それぞれに対して別々の Samba サーバを起動することは可能です。</para>
    <para>本件について、より詳しい情報は Samba 3 HOWTO に記載されています。また、 1 つのシステム内で複数のサーバを動作させる場合は、 <option>interfaces</option> と <option>bind interfaces only</option> のオプション設定にご注意ください。</para>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-client-inst">
  <title>クライアントの設定</title>

  <para>クライアント側から Samba サーバへのアクセスは、 TCP/IP 経由でのみ実施することができます。 NetBEUI や IPX などのプロトコルは、 Samba では使用できません。</para>

  <sect2 xml:id="sec-samba-client-inst-yast">
   <title>&yast; での Samba クライアントの設定</title>
   <para>Samba クライアントを設定することで、 Samba サーバや Windows サーバにあるファイルやプリンタなどの資源にアクセスすることができるようになります。また、 <menuchoice> <guimenu>ネットワークサービス</guimenu> <guimenu>Windows ドメインメンバーシップ</guimenu></menuchoice> ダイアログを使用することで、 Windows ドメインや Active Directory ドメインに参加することもできます。また、 <guimenu>Linux の認証に SMB の情報を使用する</guimenu> を選択すると、 Samba や Windows, Kerberos サーバなどの認証を使用することができるようになります。</para>
   <para><guimenu>熟練者向け設定</guimenu> を押すと、より高度な設定オプションにアクセスすることができます。たとえば <guimenu>サーバディレクトリのマウント</guimenu> の表では、サーバのホームディレクトリの認証を指定して自動的にマウントする設定を行うことができます。この方法により、 CIFS で提供されているホームディレクトリに対して、ユーザがアクセスできるようになります。詳しくは <systemitem>pam_mount</systemitem> のマニュアルページをお読みください。</para>
   <para>全ての設定が完了したら、 <guimenu>OK</guimenu> を押して閉じることで設定を保存することができます。</para>
  </sect2>

  <sect2 xml:id="sec-samba-client-old-server">
   <title>クライアント側での SMB1/CIFS 共有のマウント</title>
   <para>SMB1 (CIFS) は SMB ネットワークプロトコルの初代となるバージョンで、古くて安全性も保たれておらず、作成者である Microsoft 自身も廃止対象としているものです。また、このようなセキュリティ面の理由から、 &productname; での <command>mount</command> コマンドも、既定では SMB 2.1, SMB 3.0, SMB 3.02 の新しいプロトコルバージョンを利用して SMB 共有をマウントするようになっています。</para>
   <para>しかしながら、このような変更は <command>mount</command> コマンドを利用して、かつ <filename>/etc/fstab</filename> を利用した場合にのみ適用されます。下記のいずれかの形態で使用した場合は、従来通り SMB1 を利用することができます:</para>
   <itemizedlist>
    <listitem>
     <para><command>smbclient</command> ツールを使用した場合。</para>
    </listitem>
    <listitem>
     <para><!-- NB: profiling below is intentional - we don't support using SLED as a Samba server. --> <phrase os="sles;sled">&sls;</phrase> <phrase os="osuse">&opensuse;</phrase> に同梱されている Samba サーバソフトウエアを使用した場合。</para>
    </listitem>
   </itemizedlist>
   <para>また、既定の設定のままで使用すると、 SMB1 にのみ対応している環境では、接続が失敗することになります。 SMB1 にのみ対応している環境には、下記のようなものがあります:</para>
   <itemizedlist>
    <listitem>
     <para>新しい SMB プロトコルバージョンに対応していない SMB サーバを利用して構築している場合。 Windows では、 Windows 7 もしくは Windows Server 2008 以降で SMB 2.1 に対応しています。</para>
    </listitem>
    <listitem>
     <para>SMB1 や CIFS の Unix 拡張に依存した構成になっている場合。これらの拡張は、新しいプロトコルバージョンには移植されていません。</para>
    </listitem>
   </itemizedlist>
   <important>
    <title>セキュリティ面の危険性について</title>
    <para>下記の手順を実施してしまうと、セキュリティ面の問題を突くことができる環境を構成することになります。セキュリティ面の問題について、詳しくは <link xlink:href="https://blogs.technet.microsoft.com/filecab/2016/09/16/stop-using-smb1/"/> (英語) をお読みください。</para>
    <para>できる限り早急にお使いのサーバをアップグレードし、新しいバージョンの SMB プロトコルに対応するようにしてください。</para>
    <para os="sles;osuse">&productname; での新しいプロトコルバージョンの有効化について、詳しくは <xref linkend="sec-samba-server-new-protocol"/> をお読みください。</para>
   </important>
   <para>現在の &productname; カーネルで SMB1 共有を有効化する必要がある場合は、 <command>mount</command> コマンドを実行する際に <option>vers=1.0</option> というオプションを追加してください:</para>
<screen>&prompt.root;mount -t cifs //<replaceable>ホスト</replaceable>/<replaceable>共有名</replaceable> /<replaceable>マウントポイント</replaceable> –o username=<replaceable>ユーザ_ID</replaceable>,<emphasis role="bold">vers=1.0</emphasis></screen>
   <para>それ以外にも、 &productname; では SMB1 を全ての共有に対して有効化することもできます。これを行うには、 <filename>/etc/samba/smb.conf</filename> の <literal>[global]</literal> セクション内に下記を追加します:</para>
   <!-- Screen indentation is intentional, to match typical config file
    indentation level. -->
<screen>client min protocol = CORE</screen>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-anmeld-serv">
  <title>ログインサーバとしての Samba</title>

  <para>企業内の環境などでは、一般にユーザアカウントとパスワードを一括で管理する機能が求められます。 Windows ベースのネットワークの場合、この処理はプライマリドメインコントローラ (PDC) で処理を行います。 PDC として設定されている Windows Server が存在していればそれでもかまいませんが、 Samba サーバを PDC にすることもできます。このような構成は、 <filename>smb.conf</filename> 内の <literal>[global]</literal> セクションを、 <xref linkend="dat-samba-smb-conf-dom"/> のように設定することで可能になります。</para>

  <example xml:id="dat-samba-smb-conf-dom">
   <title>smb.conf の global セクション</title>
<screen>[global]
    workgroup = WORKGROUP
    domain logons = Yes
    domain master = Yes</screen>
  </example>

  <para>なお、ユーザアカウントパスワードは、 Windows 側の暗号化方式に準拠させるため、事前の準備が必要となります。この作業は <command>smbpasswd</command> <option>-a <replaceable>ユーザ名</replaceable></option> を実行することで行うことができます。また、 Windows のドメインの考え方では、コンピュータ向けのドメインアカウントを作成する必要もあります。コンピュータ向けのアカウントを作成するには、下記を実行します。</para>

<screen>useradd <replaceable>ホスト名</replaceable>
smbpasswd -a -m <replaceable>ホスト名</replaceable></screen>

  <para>コンピュータアカウントを作成する場合、 <command>useradd</command> コマンドの末尾にドル記号を付ける必要があります。 <command>smbpasswd</command> コマンドでは、 <option>-m</option> オプションを指定すれば自動的に追加されます。また、 <filename>/usr/share/doc/packages/samba/examples/smb.conf.SUSE</filename> にある設定例では、これを自動化するための設定が書かれています。</para>

<screen>add machine script = /usr/sbin/useradd -g nogroup -c "NT Machine Account" \
-s /bin/false %m
     </screen>

  <para>Samba 側で上記のスクリプトが正しく実行されるようにするため、必要な管理者権限のある Samba ユーザを選択して、そのユーザを <systemitem class="groupname">ntadmin</systemitem> グループに追加してください。この Linux グループに属する全てのユーザが <literal>Domain Admin</literal> になるようにするには、下記のコマンドを実行します:</para>

<screen>net groupmap add ntgroup="Domain Admins" unixgroup=ntadmin</screen>
 </sect1>
 <sect1 xml:id="sec-samba-adnet" os="sles;osuse">
  <title>Active Directory ネットワーク環境での Samba サーバ</title>

  <para>Linux サーバと Windows サーバを共存させているような環境では、それぞれが個別の認証システムや認証ネットワークを構成できるだけでなく、中央の 1 つの認証システムを利用するように構成することができます。 Samba では Active Directory ドメインとの協調作業を行うことができることから、 &productname; サーバを Active Directory (AD) のドメインに参加させることができます。</para>

  <para>Active Directory ドメインに参加するには、下記の手順を実施します:</para>

  <procedure>
   <step>
    <para>&rootuser; でログインして、 &yast; を起動します。</para>
   </step>
   <step>
    <para><menuchoice> <guimenu>ネットワークサービス</guimenu> <guimenu>Windows ドメインメンバーシップ</guimenu> </menuchoice> を選択します。</para>
   </step>
   <step>
    <para><guimenu>Windows ドメインメンバーシップ</guimenu> が表示されたら、 <guimenu>ドメインまたはワークグループ</guimenu> の欄に、参加したいドメインを入力します。</para>
    <figure>
     <title>Windows ドメインメンバーシップの決定</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="ad_sambaclient.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="ad_sambaclient.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </step>
   <step>
    <para>お使いのサーバの Linux 認証に SMB の認証を使用したい場合は、 <guimenu>Linux の認証に SMB の情報を使用する</guimenu> を選択します。</para>
   </step>
   <step>
    <para><guimenu>OK</guimenu> を押して閉じ、ドメインへの参加確認メッセージが表示されたら、それに応答します。</para>
   </step>
   <step>
    <para>あとは Active Directory サーバの Windows 管理者のユーザ名と、パスワードを入力して <guimenu>OK</guimenu> を押します。</para>
    <para>これでお使いのサーバは、認証データを Active Directory ドメインコントローラから取得できるようになっています。</para>
   </step>
  </procedure>

  <tip>
   <title>識別情報のマッピング</title>
   <para>Samba サーバが複数台存在するような環境では、 UID と GID がそれぞれ別々に管理されることになります。ユーザに対する UID の割り当ては、初回のログイン時に割り当てられることから、サーバ間では同じユーザ名でも UID が異なる結果になってしまいます。この問題を解決するには、識別情報のマッピング設定を行う必要があります。詳しくは <link xlink:href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/idmapper.html"/> をお読みください。</para>
  </tip>
 </sect1>
 <sect1 xml:id="sec-samba-advanced">
  <title>高度なトピック</title>

  <para>本章では、 Samba スイートのクライアントとサーバにおける、さらに高度な技術に関する説明を行っています。</para>

  <sect2 xml:id="sec-automount-systemd">
   <title>&systemd; を利用した CIFS ファイルシステムの自動マウント</title>
   <para>&systemd; を利用することで、 CIFS 共有を起動時にマウントすることができます。これを行うには、下記の手順を実施します:</para>
   <procedure>
    <step>
     <para>まずはマウントポイントを作成します:</para>
<screen>&prompt.user;mkdir -p <replaceable>マウントポイント</replaceable></screen>
     <para>以降は <replaceable>マウントポイント</replaceable> に <literal>/cifs/shared</literal> を指定したものとします。</para>
    </step>
    <step>
     <para>次に &systemd; のユニットファイルを作成します。このときユニットファイルのファイル名には、マウントポイントの "/" を "-" に置き換えたものを使用します。たとえば下記のようになります:</para>
<screen>&prompt.sudo;touch /etc/systemd/system/cifs-shared.mount</screen>
     <para>上記で作成したファイルには、下記の内容を記述します:</para>
<screen>
[Unit]
Description=CIFS share from The-Server

[Mount]
What=//The-Server/Shared-Folder
Where=/cifs/shared
Type=cifs
Options=rw,username=vagrant,password=admin

[Install]
WantedBy=multi-user.target
            </screen>
    </step>
    <step>
     <para>サービスを有効化します:</para>
<screen>&prompt.sudo;systemctl enable cifs-shared.mount</screen>
    </step>
    <step>
     <para>サービスを開始します:</para>
<screen>&prompt.sudo;systemctl start cifs-shared.mount</screen>
     <para>サービスが正しく開始できたかどうかを確認するには、下記のコマンドを実行します:</para>
<screen>&prompt.sudo;systemctl status cifs-shared.mount</screen>
    </step>
    <step>
     <para>CIFS で正しくマウントできたかどうかを確認するには、下記のように実行します:</para>
<screen>&prompt.user; cd /cifs/shared
&prompt.user;ls -l

total 0
-rwxrwxrwx. 1 root    root    0 10月 24 22:31 hello-world-cifs.txt
drwxrwxrwx. 2 root    root    0 10月 24 22:31 subfolder
-rw-r--r--. 1 vagrant vagrant 0 10月 28 21:51 testfile.txt
            </screen>
    </step>
   </procedure>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-compress">
   <title>btrfs による透過型ファイル圧縮</title>
   <para>Samba では、 btrfs ファイルシステム内に存在する共有に対して、クライアント側からファイルやディレクトリの圧縮フラグを遠隔で操作できるようになっています。 Windows エクスプローラでは、 <menuchoice><guimenu>ファイル</guimenu><guimenu>プロパティ</guimenu><guimenu>詳細設定</guimenu></menuchoice> 内で、透過圧縮の設定を行うことができます:</para>
   <figure>
    <title>Windows エクスプローラの <guimenu>属性の詳細</guimenu> ダイアログ</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_advattr.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_advattr.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>圧縮フラグの設定されたファイルは、そのファイルに対してアクセスや修正があるごとに、透過的に圧縮もしくは展開されます。これは通常ストレージの容量を削減する効果がありますが、ファイルにアクセスする際に CPU の負荷がかかります。また、新しいファイルやディレクトリは、 FILE_NO_COMPRESSION を指定して作成していない限り、親ディレクトリの圧縮フラグを引き継ぐようになっています。</para>
   <para>Windows エクスプローラでは、圧縮されたファイルと圧縮されていないファイルを、視覚的に区別できる形で表示します:</para>
   <figure>
    <title>圧縮されたファイルに対する Windows エクスプローラのディレクトリ一覧表示</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="samba_win_expl_view_compressed.png" width="75%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="samba_win_expl_view_compressed.png" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
   <para>Samba 共有での圧縮機能を有効化するには、</para>
<screen>vfs objects = btrfs</screen>
   <para>を <filename>/etc/samba/smb.conf</filename> 内の共有設定内に追加するか、もしくは &yast; から <menuchoice><guimenu>ネットワークサービス</guimenu><guimenu>Samba サーバ</guimenu><guimenu>Add</guimenu></menuchoice> を選択して、 <guimenu>btrfs の機能を使用する</guimenu> にチェックを入れてもかまいません。</para>
   <para os="sles">btrfs の圧縮に関する一般的な情報については、 <xref linkend="sec-filesystems-major-btrfs-compress"/> をお読みください。</para>
  </sect2>

  <sect2 xml:id="sec-samba-advanced-snapshots">
   <title>スナップショット</title>
   <para>スナップショットはシャドウコピーとも呼ばれ、特定の時点におけるファイルシステムのサブボリュームのコピーを意味します。 Linux では、 Snapper を利用することで、これらのスナップショットを管理することができます。スナップショットは btrfs ファイルシステムのほか、シン・プロビジョン型の LVM ボリュームでも利用することができます。 Samba スイートでは、サーバとクライアントとの間で FSRVP プロトコルを利用することで、リモートのスナップショットを管理することができます。</para>
   <sect3 xml:id="sec-samba-advanced-snapshots-client">
    <title>以前のバージョン</title>
    <para>Samba サーバにおけるスナップショットは、リモートの Windows クライアントから見ると、ファイルやディレクトリの <quote>以前のバージョン</quote> として見えるようになっています。</para>
    <para>Samba サーバでスナップショット機能を有効化するには、下記の条件を満たさなければなりません:</para>
    <itemizedlist mark="bullet" spacing="normal">
     <listitem>
      <para>SMB のネットワーク共有が、 btrfs のサブボリューム内に存在しなければなりません。</para>
     </listitem>
     <listitem>
      <para>SMB ネットワーク共有のパスに対して、対応する Snapper の設定ファイルを用意する必要があります。 Snapper の設定ファイルを作成するには、下記のように実行します:</para>
<screen>&prompt.sudo;snapper -c &lt;設定名&gt; create-config <option>/path/to/share</option></screen>
      <para>Snapper について、詳しくは <xref linkend="cha-snapper"/> をお読みください。</para>
     </listitem>
     <listitem>
      <para>スナップショットのディレクトリツリーは、対応するユーザに対してアクセスを許可しなければなりません。詳しくは vfs_snapper のマニュアルページ内にある PERMISSIONS セクション ( <command>man 8 vfs_snapper</command> ) をお読みください。</para>
     </listitem>
    </itemizedlist>
    <para>リモートからのスナップショット機能に対応するには、 <filename>/etc/samba/smb.conf</filename> ファイルを修正する必要があります。これは <menuchoice><guimenu>&yast;</guimenu><guimenu>ネットワークサービス</guimenu><guimenu>Samba サーバ</guimenu></menuchoice> から行うことができるほか、手作業でも設定することができます。具体的には、対応する共有に対して、下記の設定を追加します:</para>
<screen>vfs objects = snapper</screen>
    <para>なお、 <filename>smb.conf</filename> を手作業で修正した場合は、 Samba サービスを再起動する必要があります:</para>
<screen>&prompt.sudo;systemctl restart nmb smb</screen>
    <figure xml:id="fig-yast2-samba-snapshot">
     <title>スナップショットを有効化した新しい Samba 共有の追加</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_samba_snapshot.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_samba_snapshot.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
    <para>設定作業を行うことで、 Windows エクスプローラのファイルやディレクトリの <guimenu>以前のバージョン</guimenu> タブ内に、 Snapper が作成したスナップショットが表示されるようになります。</para>
    <figure xml:id="fig-samba-win-explorer">
     <title>Windows エクスプローラでの <guimenu>以前のバージョン</guimenu> タブ</title>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="samba_winexpl_previous_versions.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="samba_winexpl_previous_versions.png" format="PNG"/>
      </imageobject>
     </mediaobject>
    </figure>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-server">
    <title>リモート共有のスナップショット</title>
    <para>既定でのスナップショットは、 Samba サーバ内でコマンドラインユーティリティを使用するか、もしくは Snapper のタイムライン機能を利用することでのみ、作成もしくは削除することができます。</para>
    <para>Samba では、ファイルサーバリモート VSS プロトコル (File Server Remote VSS Protocol; VSRVP) を利用することで、リモートのホストから共有に対するスナップショットを作成したり、削除したりできるようにすることができます。</para>
    <para><xref linkend="sec-samba-advanced-snapshots-client"/> に書かれている設定と事前要件に加えて、 <filename>/etc/samba/smb.conf</filename> 内に下記のグローバル設定を追加する必要があります:</para>
<screen>[global]
rpc_daemon:fssd = fork
registry shares = yes
include = registry</screen>
    <para>これにより、 Samba の <command>rpcclient</command> や Windows Server 2012 に付属する <command>DiskShadow.exe</command> などの FSRVP クライアントから、 Samba の特定の共有に対してスナップショットを作成することができるほか、スナップショットの削除や新しい共有としての公開などを行うことができるようになります。</para>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-linux">
    <title><command>rpcclient</command> による Linux からのリモートスナップショット管理</title>
    <para><systemitem>samba-client</systemitem> パッケージには、リモートの Windows Server や Samba サーバに対して、対応する共有のスナップショットを作成したり公開したりするためのリクエストを送信することができる、 FSRVP クライアントが含まれています。共有のマウントやバックアップなどは、 &productname; に付属する既存のツールを利用することができます。また、サーバへのリクエストは <command>rpcclient</command> バイナリを利用して行います。</para>
    <example>
     <title><command>rpcclient</command> による Windows Server 2012 共有に対するスナップショット要求</title>
     <para><literal>EXAMPLE</literal> ドメイン内にある <literal>win-server.example.com</literal> サーバに対して、 Administrator で接続する場合の例です:</para>
<screen>&prompt.root;rpcclient -U '<replaceable>EXAMPLE</replaceable>\Administrator' ncacn_np:<replaceable>win-server.example.com</replaceable>[ndr64,sign]
Enter EXAMPLE/Administrator's password:</screen>
     <para><command>rpcclient</command> で SMB の共有が見えるかどうかを確認します:</para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
     <para>SMB 共有がスナップショットの作成に対応しているかどうかを確認します:</para>
<screen>&prompt.root;rpcclient $&gt; fss_is_path_sup windows_server_2012_share \
UNC \\WIN-SERVER\windows_server_2012_share\ supports shadow copy requests</screen>
     <para>スナップショット共有の作成を要求します:</para>
<screen>&prompt.root;rpcclient $&gt; fss_create_expose backup ro windows_server_2012_share
13fe880e-e232-493d-87e9-402f21019fb6: shadow-copy set created
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy added to set
13fe880e-e232-493d-87e9-402f21019fb6: prepare completed in 0 secs
13fe880e-e232-493d-87e9-402f21019fb6: commit completed in 1 secs
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
share windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777} \
exposed as a snapshot of \\WIN-SERVER\windows_server_2012_share\</screen>
     <para>サーバ側でスナップショット共有が公開されているかどうかを確認します:</para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)

netname: windows_server_2012_share@{1C26544E-8251-445F-BE89-D1E0A3938777}
remark: (null)
path:   \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy{F6E6507E-F537-11E3-9404-B8AC6F927453}\Shares\windows_server_2012_share\
password:       (null)</screen>
     <para>スナップショット共有を削除します:</para>
<screen>&prompt.root;rpcclient $&gt; fss_delete windows_server_2012_share \
13fe880e-e232-493d-87e9-402f21019fb6 1c26544e-8251-445f-be89-d1e0a3938777
13fe880e-e232-493d-87e9-402f21019fb6(1c26544e-8251-445f-be89-d1e0a3938777): \
\\WIN-SERVER\windows_server_2012_share\ shadow-copy deleted</screen>
     <para>サーバ側でスナップショット共有が削除されていることを確認します:</para>
<screen>&prompt.root;rpcclient $&gt; netshareenum
netname: windows_server_2012_share
remark:
path:   C:\Shares\windows_server_2012_share
password:       (null)</screen>
    </example>
   </sect3>
   <sect3 xml:id="sec-samba-advanced-snapshots-client-winserver">
    <title><command>DiskShadow.exe</command> による Windows からのリモートスナップショット管理</title>
    <para>Windows 側からも、 Linux Samba サーバ内の SMB 共有のスナップショットを管理することができます。 Windows Server 2012 には <command>DiskShadow.exe</command> ユーティリティが用意されていますので、 <xref linkend="sec-samba-advanced-snapshots-client-linux"/> で説明している <command>rpcclient</command> コマンドと同様に、リモートの共有に対するスナップショットを管理することができます。なお、 Samba サーバ側では、あらかじめ注意して設定を行っておく必要があります。</para>
    <para>下記は Samba サーバの共有のスナップショットを、 Windows Server のクライアント側から管理できるようにするための手順例です。なお、下記の例では <replaceable>EXAMPLE</replaceable> が Active Directory ドメインを、 <uri>fsrvp-server.example.com</uri> が Samba サーバのホスト名を、 <filename>/srv/smb</filename> が SMB 共有のパスをそれぞれ表しています。</para>
    <procedure>
     <title>より細かい Samba サーバの設定</title>
     <step>
      <para>&yast; を利用して Active Directory ドメインに参加します。 <phrase os="sles;osuse">詳しくは <xref linkend="sec-samba-adnet"/> をお読みください。</phrase></para>
     </step>
     <step>
      <para>Active Directory の DNS 項目が正しく設定されていることを確認します:</para>
<screen>fsrvp-server:~ # net -U 'Administrator' ads dns register \
fsrvp-server.example.com &lt;IP address&gt;
Successfully registered hostname with DNS</screen>
     </step>
     <step>
      <para><filename>/srv/smb</filename> 内に btrfs のサブボリュームを作成します:</para>
<screen>fsrvp-server:~ # btrfs subvolume create /srv/smb</screen>
     </step>
     <step>
      <para><filename>/srv/smb</filename> に対する Snapper の設定ファイルを作成します:</para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; create-config /srv/smb</screen>
     </step>
     <step>
      <para>&yast; で <filename>/srv/smb</filename> に対する新しい共有を作成します。このとき、 <guimenu>スナップショットの公開</guimenu> のチェックボックスにチェックが入っていることをご確認ください。また、 <xref linkend="sec-samba-advanced-snapshots-server"/> で説明しているとおり、 <filename>/etc/samba/smb.conf</filename> のグローバルセクションに下記の内容が追加されていることも、あわせてご確認ください:</para>
<screen>[global]
 rpc_daemon:fssd = fork
 registry shares = yes
 include = registry</screen>
     </step>
     <step>
      <para>あとは <command>systemctl restart nmb smb</command> を実行して Samba を再起動します。</para>
     </step>
     <step>
      <para>続いて Snapper のアクセス権を調整します:</para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config \
ALLOW_USERS="EXAMPLE\\\\Administrator EXAMPLE\\\\win-client$"</screen>
      <para>さらに <filename>.snapshots</filename> サブディレクトリに対して、 ALLOW_USERS で許可されるユーザからのアクセスを許すように設定します:</para>
<screen>fsrvp-server:~ # snapper -c &lt;snapper_config&gt; set-config SYNC_ACL=yes</screen>
      <important>
       <title>パスのエスケープ処理について</title>
       <para>'\' のエスケープ処理にご注意ください。 <filename>/etc/snapper/configs/&lt;snapper_config&gt;</filename> 内でエスケープ処理を行うため、コマンドの実行時には 2 回エスケープ処理が必要となります。</para>
      </important>
      <para>"EXAMPLE\win-client$" は Windows クライアントのコンピュータアカウントを表わしています。 Windows 側では、最初の FSRVP リクエストを、このアカウントで認証して行います。</para>
     </step>
     <step>
      <para>Windows クライアントのアカウントに対して、必要な権限を許可します:</para>
<screen>fsrvp-server:~ # net -U 'Administrator' rpc rights grant \
"EXAMPLE\\win-client$" SeBackupPrivilege
Successfully granted rights.</screen>
      <para>上記のコマンドは "EXAMPLE\Administrator" に対して実行する必要はありません。既に権限が許可されているためです。</para>
     </step>
    </procedure>
    <procedure>
     <title>Windows クライアントの設定と <command>DiskShadow.exe</command> の実行</title>
     <step>
      <para>Windows Server 2012 を起動します (この例では WIN-CLIENT というホスト名とします) 。</para>
     </step>
     <step>
      <para>&productname; と同じ Active Directory ドメイン (EXAMPLE) に参加します。</para>
     </step>
     <step>
      <para>再起動します。</para>
     </step>
     <step>
      <para>PowerShell を起動します。</para>
     </step>
     <step>
      <para><command>DiskShadow.exe</command> を起動して、バックアップ手順を開始します:</para>
<screen>PS C:\Users\Administrator.EXAMPLE&gt; diskshadow.exe
Microsoft DiskShadow バージョン 1.0
Copyright (C) 2012 Microsoft Corporation
On computer:  WIN-CLIENT,  6/17/2014 3:53:54 PM

DISKSHADOW&gt; begin backup</screen>
     </step>
     <step>
      <para>プログラム終了後やリセット／再起動後にも、シャドウコピーが保持されるように設定します:</para>
<screen>DISKSHADOW&gt; set context PERSISTENT</screen>
     </step>
     <step>
      <para>指定した共有でスナップショットが有効化されているかどうかを調べ、有効化されていればスナップショットを作成します:</para>
<screen>DISKSHADOW&gt; add volume \\fsrvp-server\sles_snapper

DISKSHADOW&gt; create
シャドウ ID {de4ddca4-4978-4805-8776-cdf82d190a4a} のエイリアス VSS_SHADOW_1 は環境変数として設定されています。
シャドウ セット ID {c58e1452-c554-400e-a266-d11d5c837cb1} のエイリアス VSS_SHADOW_SET は環境変数として設定されています。

シャドウ コピー セット ID {c58e1452-c554-400e-a266-d11d5c837cb1} を使用してすべてのシャドウ コピーを照会しています

 * シャドウ コピー ID = {de4ddca4-4978-4805-8776-cdf82d190a4a}     %VSS_SHADOW_1%
    - シャドウ コピー セット: {c58e1452-c554-400e-a266-d11d5c837cb1}  %VSS_SHADOW_SET%
    - シャドウ コピーのオリジナル カウント数 = 1
    - 元のボリューム名: \\FSRVP-SERVER\SLES_SNAPPER\ \
      [ボリュームはこのマシンにありません]
    - 作成時間: 6/17/2014 3:54:43 PM
    - シャドウ コピー デバイス名:
      \\FSRVP-SERVER\SLES_SNAPPER@{31afd84a-44a7-41be-b9b0-751898756faa}
    - 作成元のコンピューター: FSRVP-SERVER
    - サービス コンピューター: win-client.example.com
    - 露出されていません
    - プロバイダー ID: {89300202-3cec-4981-9171-19f59559e0f2}
    - 属性:  No_Auto_Release Persistent FileShare

一覧表示したシャドウ コピーの数: 1</screen>
     </step>
     <step>
      <para>最後にバックアップを完了します:</para>
<screen>DISKSHADOW&gt; end backup</screen>
     </step>
     <step>
      <para>スナップショットを作成したら、削除を行ったあと、削除ができたことを確認します:</para>
<screen>DISKSHADOW&gt; delete shadows volume \\FSRVP-SERVER\SLES_SNAPPER\
プロバイダー {89300202-3cec-4981-9171-19f59559e0f2} からボリューム \\FSRVP-SERVER\SLES_SNAPPER\ のシャドウ コピー {de4ddca4-4978-4805-8776-cdf82d190a4a} を削除しています [Attributes: 0x04000009]...

削除したシャドウ コピーの数: 1

DISKSHADOW&gt; list shadows all

コンピューター上のすべてのシャドウ コピーを照会しています...
システム内にシャドウ コピーが見つかりませんでした。</screen>
     </step>
    </procedure>
   </sect3>
  </sect2>
 </sect1>
 <sect1 xml:id="sec-samba-info">
  <title>さらなる情報</title>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>マニュアルページ:</title>
     <para><package>samba</package> パッケージでインストールされるマニュアルページの一覧を表示するには、 <command>apropos samba</command> と入力して実行します。それぞれのマニュアルページを表示するには、 <command>man <replaceable>マニュアルページの名前</replaceable></command> のように入力して実行します。</para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>&suse; 固有の README ファイル:</title>
     <para><package>samba-client</package> パッケージには、 <filename>/usr/share/doc/packages/samba/README.SUSE</filename> (英語) というファイルが含まれています。</para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>追加のパッケージドキュメンテーション:</title>
     <para><systemitem>samba-doc</systemitem> パッケージを <command>zypper install samba-doc</command> と入力して実行し、インストールしてください。</para>
    </formalpara>
    <para>このドキュメンテーションパッケージは、ファイルを <filename>/usr/share/doc/packages/samba</filename> にインストールします。ここにはマニュアルページの HTML 版のほか、設定例集なども含まれています (例: <filename>smb.conf.SUSE</filename>) 。</para>
   </listitem>
   <listitem>
    <formalpara>
     <title>オンラインのドキュメンテーション:</title>
     <para>Samba wiki にはさまざまな <citetitle>User Documentation</citetitle> (ユーザ向けドキュメンテーション) (英語) が含まれています。 <link xlink:href="https://wiki.samba.org/index.php/User_Documentation"/> からアクセスしてください。</para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>

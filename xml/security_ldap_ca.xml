<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 [
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec-security-ldap-server-ca">
 <title>TLS 証明書と鍵の取り込み</title>
 <para>&ds389; の証明書や鍵を管理するには、 <command>certutil</command> , <command>openssl</command> , <command>pk12util</command> のようなコマンドラインツールを使用します。</para>
 <para>新しい &ds389a; インスタンスを作成すると、 <command>dscreate</command> は独自の証明機関を作成し、自己署名型のサーバ証明書を発行します。こちらはテスト用途にのみ使用されるべきもので、証明書のファイルは <filename>/etc/dirsrv/slapd-<replaceable>インスタンス名</replaceable>/</filename> 内に配置されます。</para>
  <para>本番環境を構築する場合は、 Let's Encrypt, CAcert.org, SSL.com など、第三者が発行する証明書を使用するようにしてください。それぞれサーバ証明書、クライアント証明書、ルート証明書が必要になります。</para>
 <procedure>
  <para>NSS データベース内に機密鍵と証明書を取り込む前に、機密鍵と証明書をバンドルとして 1 つにまとめておく必要があります。まとめたファイルは <filename>*.p12</filename> というファイル名になっているはずです。</para>
  <important>
  <title><filename>*.p12</filename> ファイルとフレンドリ名について</title>
  <para>PKCS12 バンドルを作成する際、 <filename>*.p12</filename> 内のフレンドリ名として、 <literal>Server-Cert</literal> という名前を指定しなければなりません。この名前で作成しておかないと、 &ds389; が証明書を検出できず、 TLS 接続が失敗することになってしまいます。</para>
  <para>また、フレンドリ名は <filename>*.p12</filename> を取り込んだ後では変更することができません。</para>
 </important>
 <step>
  <para>必要な名前で PKCS12 バンドルを作成するには、下記のようなコマンドを実行します:</para>
<screen>&prompt.sudo;<command>openssl pkcs12 -export -in <replaceable>SERVER.crt</replaceable></command> \ 
<command>-inkey <replaceable>SERVER.key</replaceable></command> \
<command>-out <replaceable>SERVER.p12</replaceable> -name Server-Cert</command></screen>
  <para>ここで、 <replaceable>SERVER.crt</replaceable> には取り込むべきサーバ証明書のファイル名を、 <replaceable>SERVER.key</replaceable> にはそれに対応した機密鍵のファイル名をそれぞれ指定します。また、 <option>-out</option> 以降では出力先の <filename>*.p12</filename> ファイル名を指定しています。最後の <option>-name</option> はフレンドリ名の指定 (<literal>Server-Cert</literal>) です。</para>
 </step>
 <step>
   <para>また、 NSS データベースに取り込む前に、パスワードを取得しておく必要があります。下記のようなコマンドを実行してください:</para>
<screen>&prompt.sudo;<command>pk12util -i <replaceable>SERVER.p12</replaceable></command> \
<command>-d sql:<replaceable>NSS_データベースのパス</replaceable> -n Server-Cert -W <replaceable>パスワード</replaceable></command></screen>
   <para>上記を実行すると、 <filename><replaceable>PATH_TO_NSS_DB</replaceable></filename> で指定したディレクトリ内に <filename>pwdfile.txt</filename> ファイルが作成されます。このファイル内にパスワードが出力されます。</para>
 </step>
 <step>
  <para>最後に &ds389a; の NSS データベース内に <replaceable>SERVER.p12</replaceable> ファイルを取り込みます:</para>
  <screen>&prompt.sudo;<command>pk12util -i <replaceable>SERVER.p12</replaceable></command> \
<command>-d /etc/dirsrv/slapd-<replaceable>インスタンス名</replaceable>/cert9.db</command></screen>
 </step>
 </procedure>
 </sect1>

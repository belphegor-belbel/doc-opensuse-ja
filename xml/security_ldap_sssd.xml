<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 [
<!ENTITY % entities SYSTEM "generic-entities.ent">
%entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec-security-ldap-server-sssd">
  
  <title>LDAP 認証管理のための SSSD の使用</title>
  <para>システムセキュリティサービスデーモン (System Security Services Daemon (SSSD)) は、リモートのユーザに対する認証や識別、アクセス制御などを行うためのシステムです。本章では、 &ds389; と SSSD を利用して、ユーザ認証やユーザ識別を行うための手順を説明しています。</para>
  <para>SSSD は LDAP サーバとクライアントとの間を仲介します。 LDAP のほか、 Active Directory や Kerberos などのバックエンドにも対応しています。サービス側としては SSH, PAM, NSS, sudo などに対応しています。 SSSD は ID や資格情報をキャッシュする仕組みが存在することから、性能面だけでなく柔軟性も兼ね備えています。キャッシュ機能は &ds389; サーバの負荷を減らすことにつながるばかりか、バックエンドが接続不可能な状態になっても、認証機能を継続して提供することができるようになります。</para>
  <para>なお、ネームサービスキャッシュデーモン (Name Services Caching Daemon (ncsd)) がネットワーク内で動作している場合は、無効化するか削除しておいてください。 nscd は passwd, group, hosts, service, netgroup などの名前解決要求のみをキャッシュする仕組みであることから、 SSSD と競合してしまうためです。</para>
  <para>LDAP サーバをプロバイダ (提供元) として使用する場合、 SSSD のインスタンスはプロバイダに対するクライアントとして動作します。 &ds389a; サーバ内で SSSD を動作させてもかまいませんが、異なるマシンで動作させることで、 &ds389a; サーバが接続不可能な状況に陥った場合でもサービスを継続させることができます。下記の手順では、 SSSD クライアントのインストールと設定について説明しています。</para>
  <procedure>
    <step>
      <para>まずは <systemitem>sssd</systemitem> と <systemitem>sssd-ldap</systemitem> の各パッケージをインストールします:</para>
    <screen>&prompt.sudo;<command>zypper in sssd sssd-ldap</command></screen>
  </step>
  <step>
    <para>既定の <filename>/etc/sssd/sssd.conf</filename> ファイルをバックアップしておきます:</para>
  <screen>&prompt.sudo;<command>old /etc/sssd/sssd.conf</command></screen>
  </step>
  <step>
   <para>あとは新しい SSSD 設定を作成していきます。下記は、基本的なクライアント設定の例です:</para>
   <screen>
&prompt.sudo;<command>dsidm <replaceable>インスタンス名</replaceable> client_config /etc/sssd/sssd.conf</command>
</screen>
  </step>
  <step>
    <para>出力された内容を確認して、環境に合わせた変更を行います。下記は <filename>/etc/sssd/sssd.conf</filename> ファイルの設定例 (全体) です。</para>
    <screen>[sssd]
services = nss, pam, ssh, sudo
config_file_version = 2
domains = default

[nss]
homedir_substring = /home

[domain/default]
# 多数の (具体的には 50 個以上の) グループを設定する場合、# 下記は True に設定しておくことをお勧めします
ignore_group_members = False
debug_level=3
cache_credentials = True
id_provider = ldap
auth_provider = ldap
access_provider = ldap
chpass_provider = ldap
ldap_schema = rfc2307bis
ldap_search_base = <replaceable>dc=example,dc=com</replaceable>
# ldaps の使用をお勧めします
ldap_uri = <replaceable>ldaps://ldap.example.com</replaceable>
ldap_tls_reqcert = demand
ldap_tls_cacert = /etc/openldap/ldap.crt
ldap_access_filter = (|(memberof=cn=&lt;login group&gt;,ou=Groups,dc=example,dc=com))
enumerate = false
access_provider = ldap
ldap_user_member_of = memberof
ldap_user_gecos = cn
ldap_user_uuid = nsUniqueId
ldap_group_uuid = nsUniqueId
ldap_account_expire_policy = rhds
ldap_access_order = filter, expire
ldap_user_ssh_public_key = nsSshPublicKey</screen>
  </step>
  <step>
    <para>
      Set file ownership to root, and restrict read-write permissions to root:
    </para>
    <screen>&prompt.sudo;<command>chown root:root /etc/sssd/sssd.conf</command>
&prompt.sudo;<command>chmod 600 /etc/sssd/sssd.conf</command></screen>
  </step> 
  <step>
    <para>SSSD サーバ内の <filename>/etc/nsswitch.conf</filename> 設定ファイルを編集し、下記のような行が含まれるようにします:</para>
    <screen>passwd: compat sss
group:  compat sss
shadow: compat sss</screen>
</step>
<step>
  <para>SSSD サーバ内の PAM 設定である <filename>common-account-pc</filename> , <filename>common-auth-pc</filename> , <filename>common-password-pc</filename> , <filename>common-session-pc</filename> をそれぞれ編集します。 &sle; では <command>pam-config</command> というコマンドを使用することで、これら全てのファイルを一括変更することができます:</para>
<screen>&prompt.sudo;<command>pam-config -a --sss</command></screen>
  </step>
  <step>
    <para>あとは修正後の設定を確認します:</para>
    <screen>&prompt.sudo;<command>pam-config -q --sss</command>
auth:
account:
password:
session:</screen>
</step>
<step>
    <para>さらに、 &ds389; サーバ内にある <filename>/etc/dirsrv/slapd-<replaceable>インスタンス名/</replaceable>ca.crt</filename> ファイルを SSSD サーバ内の <filename>/etc/openldap/certs</filename> にコピーして、ハッシュを再作成します:</para>
<screen>&prompt.sudo;<command>c_rehash /etc/openldap/certs</command></screen>
   </step>
   <step>
    <para>SSSD を有効化して開始します:</para>
    <screen>&prompt.sudo;<command>systemctl enable --now sssd</command></screen>
   </step>
  </procedure>
        <!-- this will go to a separate section cschroder 2021-10-21
   <step>
    <para>
     Your users must have their own SSH key pairs, and SSH access to your SSSD server.
     If everything is set up correctly, &exampleuserII; can access the &ds389;
     instance via SSH to the machine where you have installed and configured
     SSSD. However, &exampleuserIII; will fail to do so, because &exampleuserIII;
     does not belong to the group <literal>server_admins</literal>, as
     configured in <xref linkend="pro-security-ldap-server-groups"/>.
    </para>
      <important>
     <para>
      The <literal>memberOf</literal> plug-in needs to be enabled, so that
      clients can log in and authorize (see <xref linkend="sec-security-ldap-modules"/>).
     </para>
    </important>
  
   </step>-->
  <para>systemctl での sssd.service の制御方法については、 <xref linkend="cha-security-auth"/> をお読みください。</para>
  </sect1>

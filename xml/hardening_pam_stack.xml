<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet href="urn:x-suse:xslt:profiling:docbook50-profile.xsl"
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE sect1 [
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec-sec-prot-general-pam">
 <title>PAM を利用したパスワードとログインの管理</title>

    <para>Linux-PAM (Pluggable Authentication Modules for Linux) は共有ライブラリから成るパッケージスイートで、ローカルのシステム管理者に対してアプリケーションからのユーザ認証方法を設定する機能を提供します。</para>

    <para>PAM が提供する機能のほか、この仕組みによって提供される環境ごとの最適な構成方式については、よく知っておくことをお勧めします。この設定作業は一度だけ実施すればよく、全てのシステムに対して同じ設定を行っておく (設定の標準化) こともできますし、そこからさらにホスト固有の設定を追加する (特定のホストやサービス、アプリケーションに対するセキュリティ強化) こともできます。これはつまり、この仕組みが非常に柔軟な構造であることを理解することにもなります。</para>

    <para>PAM のアーキテクチャを詳しく知りたい場合は、 <filename>/usr/share/doc/packages/pam</filename> ディレクトリ内にある PAM のドキュメンテーション (英語) をお読みになることをお勧めします。ここには様々な形式が用意されています。</para>

    <para>下記の説明では、特にパスワードの強度ポリシーに関する設定など、既定の PAM 設定の変更方法の例を示しています。これにはたとえばパスワードそのものの複雑性のほか、パスワードの再利用やアカウントのロックアウト (一時的な無効化) も含まれます。これらは機能全体のうちのごく一部ではありますが、 PAM の構造や柔軟性を理解するには最適な例です。</para>
    <important>
        <title><command>pam-config</command> の制限について</title>
        <para><command>pam-config</command> ツールは PAM の設定ファイルのうち、 common-{account,auth,password,session} の各設定ファイルを変更するために使用します。これらのファイルにはグローバルオプションのほか、下記のようなコメントが書かれています:</para>
        <screen># This file is autogenerated by pam-config. All changes
# will be overwritten.
# (このファイルは pam-config で自動生成されたものです。直接ここで編集を
# 行っても、上書きされてしまう可能性があります)</screen>
        <para>それ以外の個別のサービスファイル、たとえば <filename>login, password, sshd</filename> , <filename>su</filename> などのファイルについては、手作業で編集しなければなりません。もちろん <command>pam-config</command> を全く使用せず、全てのファイルを手作業で編集してもかまいません。ですが <command>pam-config</command> には古い設定の変換や現在の設定の更新、そして正当性のチェックなど、様々な機能が用意されています。詳しくは <command>man 8 pam-config</command> で表示されるマニュアルページをお読みください。</para>
    </important>

    <sect2 xml:id="sec-sec-prot-general-pam-pw-strength">
     <title>パスワードの強度</title>
     <para>&productname; ではパスワードの強度を調べるための <systemitem class="library">pam_cracklib</systemitem> ライブラリが提供されています。このライブラリは、パスワードが弱すぎるような場合、より強いパスワードの使用を提案する機能も備えています。下記では、このライブラリが提供する、パスワードポリシーの設定や監査目的で使用する各種のパラメータについて説明しています。</para>
     <para>PAM ライブラリは指定された順序で処理を行います。完璧に期待通りの動作になるよう、要件とポリシーをフローチャートの形にまとめてから設定することをお勧めします。</para>
     <table>
      <title>パスワードの強度に関するルール例</title>
      <tgroup cols="3">
       <tbody>
        <row>
         <entry>
          <para><systemitem class="library">pam_cracklib.so</systemitem></para>
         </entry>
         <entry>
          <para><literal>minlen=8</literal></para>
         </entry>
         <entry>
          <para>パスワードの文字数の最小値を指定します。ここでは 8 文字を指定しています</para>
         </entry>
        </row>
        <row>
         <entry>
          <para><systemitem class="library">pam_cracklib.so</systemitem></para>
         </entry>
         <entry>
          <para><literal>lcredit=-1</literal></para>
         </entry>
         <entry>
          <para>パスワードのうち、小文字の文字数の最小値を指定します。ここでは 1 文字を指定しています</para>
         </entry>
        </row>
        <row>
         <entry>
          <para><systemitem class="library">pam_cracklib.so</systemitem></para>
         </entry>
         <entry>
          <para><literal>ucredit=-1</literal></para>
         </entry>
         <entry>
          <para>パスワードのうち、大文字の文字数の最小値を指定します。ここでは 1 文字を指定しています</para>
         </entry>
        </row>
        <row>
         <entry>
          <para><systemitem class="library">pam_cracklib.so</systemitem></para>
         </entry>
         <entry>
          <para><literal>dcredit=-1</literal></para>
         </entry>
         <entry>
          <para>パスワードのうち、数字の文字数の最小値を指定します。ここでは 1 文字を指定しています</para>
         </entry>
        </row>
        <row>
         <entry>
          <para><systemitem class="library">pam_cracklib.so</systemitem></para>
         </entry>
         <entry>
          <para><literal>ocredit=-1</literal></para>
         </entry>
         <entry>
          <para>パスワードのうち、その他の文字数の最小値を指定します。ここでは 1 文字を指定しています</para>
         </entry>
        </row>
       </tbody>
      </tgroup>
     </table>
     <para>これらのパスワード制限を設定するにあたっては、 <command>pam-config</command> ツールを利用することができます。たとえばパスワードの長さの最小値を設定したい場合は、下記のように入力して実行します:</para>
<screen>&prompt.sudo;pam-config -a --cracklib-minlen=8 --cracklib-retry=3 \
--cracklib-lcredit=-1 --cracklib-ucredit=-1 --cracklib-dcredit=-1 \
--cracklib-ocredit=-1 --cracklib</screen>
     <para>これで新しいパスワードに対する強度チェックが行われるようになります。あとは root 以外のアカウントでログインしなおし、 <command>passwd</command> コマンドでパスワードを設定して試してみるとよいでしょう。なお上記の要件は、 root で <command>passwd</command> コマンドを実行した場合には適用されないことに注意してください。</para>
    </sect2>

    <sect2 xml:id="sec-sec-prot-general-pam-pw-previous">
     <title>過去に使用したことのあるパスワードの制限</title>
     <para>pam_pwhistory モジュールを使用することで、過去に使用したことのあるパスワードを禁止するように設定することもできます。下記の例では、少なくとも過去 6 ヶ月間は、以前のパスワードを使用できないようにシステムを設定します:</para>
     <screen>&prompt.sudo;pam-config -a --pwhistory --pwhistory-remember=26</screen>
     <para><xref linkend="sec-sec-prot-general-pw-aging"/> では <literal>PASS_MIN_DAYS</literal> に <literal>7</literal> を設定しています。これはパスワードを変更する際の最小間隔を指定する項目です。上記のように <systemitem>pam_unix</systemitem> に <literal>26</literal> を設定すると、過去 26 回分 (つまり、最低でも 26*7 日分 = 約 6 ヶ月分) のパスワードを記憶して、使用できないようにすることができます。</para>
     <para>ここまでの <command>pam-config</command> の設定で生成された PAM の設定ファイル ( <filename>/etc/pam.d/common-auth</filename> ) の内容は、下記のようになります:</para>
     <screen>auth      required   pam_env.so
auth      required   pam_unix.so     try_first_pass
account   required   pam_unix.so     try_first_pass
password  requisit   pam_cracklib.so
password  required   pam_pwhistory.so        remember=26
password  optional   pam_gnome_keyring.so    use_authtok
password  required   pam_unix.so     use_authtok nullok shadow try_first_pass
session   required   pam_limits.so
session   required   pam_unix.so     try_first_pass
session   optional   pam_umask.so</screen>
    </sect2>

    <sect2 xml:id="sec-sec-prot-general-pam-lock-accounts">
     <title>ログイン失敗時のユーザアカウントのロックアウト</title>
     <para>ssh, login, su, sudo などで一定回数以上のログイン失敗が繰り返された場合、対象のアカウントをロックアウトする措置は、一般的なセキュリティ対策として実施されるものです。しかしながら、これを実施してしまうとアプリケーションや管理者、 root ユーザでのログインができなくなってしまいますから、悪意のある攻撃者がサービス拒否攻撃として使用できてしまうものでもあります。幸いなことに、 PAM での制御は非常に直感的です。</para>
     <important>
      <title>Denial-of-service attacks</title>
      <para>
       Password failure counts can easily be abuse to cause denial-of-service
       attacks by deliberately creating login failures.
      </para>
      <para>
       Only use password failure counts if you have to. Ristrict locking to the
       necessary minimum and do not lock critical accounts. Keep in mind that
       lockig not only applies to human users but also to system accounts used
       to provide services.
      </para>
     </important>
     <para>既定では PAM は全ての root ログインを許可します。 <command>pam_tally2</command> モジュールを使用することで、その他のユーザ (一般ユーザおよびシステムユーザ) に対するロックアウトを設定することができます。 <filename>/etc/pam.d/login</filename> 内の冒頭に下記の内容を記述することで、 root を除く全ユーザに対し、 6 回のログイン失敗時に 10 分間のロックアウトを設定することができます:</para>
<screen>auth required pam_tally2.so deny=6 unlock_time=600</screen>
     <para>下記は <filename>/etc/pam.d/login</filename> ファイルに設定した場合の例です:</para>
<screen>#%PAM-1.0
auth     requisite      pam_nologin.so
auth     include        common-auth
auth     required       pam_tally2.so deny=6 unlock_time=600
account  include        common-account
account  required       pam_tally2.so
password include        common-password
session  required       pam_loginuid.so
session  include        common-session
#session  optional       pam_lastlog.so nowtmp showfailed
session  optional       pam_mail.so standard</screen>        
     <para>root ユーザに対してもロックアウトを設定することができますが、注意してお使いください:</para>
<screen>auth required pam_tally2.so deny=6 even_deny_root unlock_time=600</screen>
     <para>root に対して異なるロックアウトを設定することもできます:</para>
     <screen>auth required pam_tally2.so deny=6 root_unlock_time=120  unlock_time=600</screen>
    <para>ロックアウトの解除を自動では行わず、管理者の操作を必要としたい場合は、 <literal>unlock_time</literal> オプションを削除してください。下記の 2 つのコマンド例では、ログイン失敗回数を表示して、ロックアウト解除を行う例を示しています:</para>
<screen>&prompt.root;<command>pam_tally2 -u <replaceable>username</replaceable></command>
Login           Failures Latest failure     From
username            6    12/17/19 13:49:43  pts/1

&prompt.root;<command>pam_tally2 -r -u <replaceable>username</replaceable></command></screen>
       
     <para>ログインを試した記録は、既定で <filename>/var/log/tallylog</filename> 内に保存されます。</para>
     <para>ロックアウト時間の経過後や管理者によるロックアウト解除を実施すると、上記のカウンタは 0 にリセットされます。</para>
     <para>その他のログインサービスで <command>pam_tally2</command> を使用するには、 <filename>/etc/pam.d/</filename> 内にあるそれぞれの設定ファイル (<filename>sshd, su, sudo, sudo-i, su-l</filename>) に設定を追加してください。</para>
 </sect2>     
</sect1>

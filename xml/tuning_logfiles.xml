<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter [
<!ENTITY % entities SYSTEM "generic-entities.ent">
%entities;
]>
<!-- fs 2010-05-10:
  TODO:
  * more on logrotate?
  * logger

Syslog, logging general:
http://www.linux-tutorial.info/modules.php?name=MContent&pageid=56
http://www.linux-tutorial.info/modules.php?name=MContent&pageid=59

Logger:
https://tldp.org/LDP/LGNET/148/darin.html
-->
<chapter xmlns:its="http://www.w3.org/2005/11/its" xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="cha-tuning-syslog">
 <title>システムログファイル</title>
 <info>
    <meta name="description" its:translate="yes">Learn to analyze and troubleshoot a SUSE system by examining its various log file locations, then apply the knowledge in a real-world scenario</meta>
      <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
        <dm:bugtracker>
        </dm:bugtracker>
	<dm:translation>yes</dm:translation>
      </dm:docmanager>
    <revhistory xml:id="rh-cha-tuning-syslog">
   <revision>
     <date>2023-08-11</date>
     <revdescription>
       <para/>
     </revdescription>
   </revision>
 </revhistory>
</info>
    <para>システムログファイルの分析作業は、システムを分析する際に最も重要な作業です。事実、システムのメンテナンスやトラブルシューティングを行う場合、一般的には何よりも先にシステムログファイルを確認します。 &productname; では、システム内で発生した事象をほぼ全て詳細に記録します。また &systemd; への移行により、カーネルメッセージとシステムサービスが発するメッセージは、 &systemd; 内に保管されるようになっています (詳しくは <xref linkend="cha-journalctl"/> をお読みください) 。その他のログファイル (主にシステムアプリケーションが記録するもの) については、従来通り純粋なテキスト形式で記録され、エディタやページャなどを利用すれば簡単に読むことができます。このほか、スクリプトを利用してそれらを処理することもできますので、これにより特定の内容だけを抜き出すこともできます。</para>
 <sect1 xml:id="sec-tuning-syslog-logs">
  <title><filename>/var/log/</filename> 内にあるシステムログファイル</title>

  <para>システム関係のログファイルは、必ず <filename>/var/log</filename> ディレクトリ内に存在しています。下記の一覧には、 &productname; 既定のインストール後の環境に現れる、全てのシステムログファイルを示しています。もちろん追加のソフトウエアをインストールすることで、 <filename>/var/log</filename> には下記に示していない様々なログファイルが作成されます。また、ファイルやディレクトリによっては <quote>プレースホルダ</quote> として用意されるだけで、実際に対応するアプリケーションをインストールしないと、使用されないものもあります。さらに、ほとんどのログファイルは &rootuser; でないと読むことができません。</para>

  <variablelist>
<!-- fs 2016-11-17:
     The acpid daemon has been dropped with SLE 12; the file is still there,
     but empty

   <varlistentry>
    <term><filename>acpid</filename>
    </term>
    <listitem>
     <para>
      Log of the advanced configuration and power interface event daemon
      (<systemitem class="daemon">acpid</systemitem>), a daemon to notify
      user-space programs of ACPI events.
      <systemitem class="daemon">acpid</systemitem> will log all of its
      activities,  the <systemitem>STDOUT</systemitem> and
      <systemitem>STDERR</systemitem> of any actions to syslog.
     </para>
    </listitem>
    </varlistentry>
-->
   <varlistentry>
    <term><filename>apparmor/</filename></term>
    <listitem>
     <para>&aa; のログファイルが配置されます。 &aa; に関する詳細は、 <xref linkend="part-apparmor"/> をお読みください。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>audit/</filename></term>
    <listitem>
     <para>監査フレームワークのログファイルが配置されます。詳しくは <xref linkend="part-audit"/> をお読みください。</para>
    </listitem>
   </varlistentry>
<!-- 2014-06-04 tbazant: now part of journald
   <varlistentry>
    <term><filename>boot.msg</filename>
    </term>
    <listitem>
     <para>
      Log of the system init process&mdash;this file contains all boot
      messages from the kernel, the boot scripts and the services started
      during the boot sequence.
     </para>
     <para>
      Check this file to find out whether your hardware has been correctly
      initialized or all services have been started successfully.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>boot.omsg</filename>
    </term>
    <listitem>
     <para>
      Log of the system shutdown process - this file contains all messages
      issued on the last shutdown or reboot.
     </para>
    </listitem>
   </varlistentry>
   -->
   <varlistentry>
    <term><filename>ConsoleKit/</filename></term>
    <listitem>
     <para><systemitem class="daemon">ConsoleKit</systemitem> デーモン (どのユーザがログインしてどのような作業を行ったのかを追跡するデーモン) のログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>cups/</filename></term>
    <listitem>
     <para>汎用 Unix 印刷システム (Common Unix Printing System ( <systemitem class="daemon">cups</systemitem> )) のアクセスログファイルとエラーログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>firewall</filename></term>
    <listitem>
     <para>ファイアウオール機能のログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>gdm/</filename></term>
    <listitem>
     <para>&gnome; ディスプレイマネージャのログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>krb5/</filename></term>
    <listitem>
     <para>Kerberos ネットワーク認証システムのログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>lastlog</filename></term>
    <listitem>
     <para>各ユーザの最終ログイン日時に関する情報を保持するデータベースです。 <command>lastlog</command> コマンドを使用すると、内容を読むことができます。詳しくは <command>man 8 lastlog</command> をお読みください。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>localmessages</filename></term>
    <listitem>
     <para>いくつかの起動スクリプトのログメッセージが含まれています。たとえば DHCP クライアントのログなどがあります。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>mail*</filename></term>
    <listitem>
     <para>メールサーバ ( <systemitem class="service">postfix</systemitem> , <systemitem class="service">sendmail</systemitem> など) のログファイルが配置されます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>messages</filename></term>
    <listitem>
     <para>全てのカーネルメッセージやシステムのログメッセージが記録されるファイルで、何らかの問題が発生した場合は、 <filename>/var/log/warn</filename> ファイルとともに、最初に確認しておくべきファイルでもあります。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>NetworkManager</filename></term>
    <listitem>
     <para>NetworkManager のログファイルです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>news/</filename></term>
    <listitem>
     <para>ニュースサーバからのログファイルが配置されるディレクトリです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>chrony/</filename></term>
    <listitem>
     <para>Network Time Protocol デーモン (&chrony;) のログファイルが配置されるディレクトリです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>pk_backend_zypp*</filename></term>
    <listitem>
     <para>PackageKit (with <systemitem class="library">libzypp</systemitem> バックエンド) のログファイルです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>samba/</filename></term>
    <listitem>
     <para>Windows SMB/CIFS ファイルサーバである Samba のログファイルが配置されるディレクトリです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>warn</filename></term>
    <listitem>
     <para>全てのシステム内の警告およびエラーが記録されるファイルです。何らかの問題が発生した場合は、 &systemd; ジャーナルの出力とともに、最初に確認しておくべきファイルでもあります。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>wtmp</filename></term>
    <listitem>
     <para>全てのログイン／ログアウト処理 <remark>sknorr, 2014-08-21: why was "runlevel changes" commented out here?Is this a systemd-related change? Should this then be removed entirely?</remark> とリモート接続のデータベースです。  <command>last</command> コマンドを使用すると、内容を読むことができます。詳しくは <command>man 1 last</command> をお読みください。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>Xorg.<replaceable>数字</replaceable>.log</filename></term>
    <listitem>
     <para>&xvendor; の起動時のログファイルです。 &xvendor; の起動に何らかの問題が発生した場合は、このファイルを参照してください。</para>
     <para>なお、ファイル名の <replaceable>数字</replaceable> の箇所には、ディスプレイ番号が入ります。たとえば <filename>Xorg.0.log</filename> であれば既定のディスプレイ番号である <literal>0</literal> のログファイルになりますし、 <filename>Xorg.1.log</filename> であればディスプレイ番号 <literal>1</literal> のログファイルになります。また、古い &xvendor; のログファイルは <filename>Xorg.<replaceable>数字</replaceable>.log.old</filename> の形式で保存されます。</para>
     <note>
      <para>なお、 &xvendor; を <systemitem>root</systemitem> で起動した場合にのみ、 <filename>/var/log/</filename> ディレクトリ内にログが記録されることに注意してください。その他の (一般) ユーザで &xvendor; を起動した場合は、 <filename>~/.local/share/xorg/</filename> ディレクトリ内にログが保存されます。</para>
     </note>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>YaST2/</filename></term>
    <listitem>
     <para>全ての &yast; ログファイルが含まれるディレクトリです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>zypp/</filename></term>
    <listitem>
     <para><systemitem class="library">libzypp</systemitem> のログファイルが含まれるディレクトリです。パッケージのインストール履歴を読みたい場合は、これらのファイルを参照してください。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>zypper.log</filename></term>
    <listitem>
     <para>コマンドラインインストーラである <command>zypper</command> のログファイルです。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-tuning-syslog-view">
  <title>ログファイルの表示と処理</title>

  <para>ログファイルを表示したい場合は、任意のテキストエディタをお使いいただくことができます。それ以外にも、 &yast; コントロールセンターから <menuchoice> <guimenu>その他</guimenu> <guimenu>システムログ</guimenu> </menuchoice> と選択していくことで、ログを閲覧するためのシンプルな &yast; モジュールを起動することもできます。</para>

  <para>テキストコンソールでログファイルを閲覧したい場合は、 <command>less</command> や <command>more</command> のコマンドを使用します。それ以外にも、 <command>head</command> や <command>tail</command> コマンドを使用することで、ログの冒頭や末尾だけを表示することもできます。ログファイルに追記される内容をリアルタイムに読みたい場合は、 <command>tail</command> <option>-f</option> コマンドをお使いください。これらのツールの使用方法について、詳しくはそれぞれのマニュアルページをお読みください。</para>

  <para>特定の文字列や正規表現を指定してログ内を検索したい場合は、 <command>grep</command> ツールをお使いください。また、 <command>awk</command> を使用することで、ログファイルの処理や書き換えなどを行うこともできます。</para>
 </sect1>
 <sect1 xml:id="sec-tuning-syslog-logrotate">
  <title><command>logrotate</command> によるログの管理</title>

  <para><filename>/var/log</filename> 以下にあるログファイルは日々増えていくもので、容易に巨大化してしまいます。 <command>logrotate</command> はそのようなログファイルを管理することができるツールです。ログファイルを自動的にローテーション (新しいログファイルへの切り替え) したり、削除や圧縮、メール送信などを行ったりすることができます。ログファイルは定期的 (毎日, 毎週, 毎月など) に処理することができるほか、特定のサイズに達した際に実行することもできます。</para>

  <para><command>logrotate</command> は &systemd; によって毎日起動されるようになっているため、ログファイルに対する処理は毎日 1 回実行されます。しかしながら、一定のサイズを超過した場合に発動するように設定している場合や、 <option>--force</option> オプションを指定したりしたような場合は、それ以上に実行することもできます。それぞれのファイルをどのタイミングで直近にローテーションしたいのかを確認するには、 <filename>/var/lib/misc/logrotate.status</filename> ファイルをご覧ください。</para>

  <para><command>logrotate</command> におけるメインとなる設定ファイルは、 <filename>/etc/logrotate.conf</filename> です。システムパッケージやシステムプログラムによっては、独自のログファイルを生成するものがあります (たとえば <systemitem class="resource">apache2</systemitem> ) が、その場合はそれらのログファイルに対応する設定を <filename>/etc/logrotate.d/</filename> ディレクトリ内に配置します。 <filename>/etc/logrotate.d/</filename> 内の設定は、 <filename>/etc/logrotate.conf</filename> から取り込むように設定します。</para>

  <example xml:id="ex-tuning-syslog-logrotate-config">
   <title><filename>/etc/logrotate.conf</filename> の例</title>
   <para><remark> taroth 2017-12-14: for the sake of using the prompt entities (&prompt.user; or &prompt.root;) consistently in our docs: please do not mix several example commands within one screen and do not use '#' to refer to an example command - this makes it impossible to mark the individual commands with a proper prompt </remark></para>
<screen># 詳しくは "man logrotate" で表示されるマニュアルページをお読みください
# 毎週ログファイルをローテーションする指定
weekly

# 4 週分までを保管する設定
rotate 4

# 古いログファイルをローテーションした場合、新しい (空の) ログファイルを作成する指定

# ローテーションしたファイルに対して、ファイル名の末尾に日付を付与する指定
dateext

# ログファイルを圧縮したい場合は、下記の行のコメント文字を削除してください

# gzip など、他の圧縮形式を使用したい場合は、下記 2 行をコメントアウトしてください
compresscmd /usr/bin/bzip2
uncompresscmd /usr/bin/bunzip2

# RPM パッケージによっては、下記のディレクトリ内に設定ファイルを配置するものがあります
include /etc/logrotate.d</screen>
  </example>

  <important>
   <title>パーミッションの矛盾回避について</title>
   <para><systemitem>create</systemitem> オプションを使用する場合は、 <filename>/etc/permissions*</filename> で指定することのできるファイルのモードと所有者に注意する必要があります。これらの設定を変更している場合は、矛盾が起こらないように設定してください。</para>
  </important>


<!-- man page info:


   Any number of configuration files may be given on the command line. Later con-
       fig files may override the options given in earlier files, so the order
       in  which  the logrotate configuration files are listed in is important.  Nor-
       mally, a single configuration file which includes any other configuration files which
       are  needed  should  be used.  See below for more information on how to
       use the include directive to accomplish this.  If a directory is  given
       on  the  command line, every file in that directory is used as a config
       file.

       logrotate [-dv] [-f|- -force] [-s| - -state file] config_file+



OPTIONS

       -v     Turn on verbose mode.


       -d     Turns  on  debug mode and implies -v.  In debug mode, no changes
              will be made to the logs or to the logrotate state file.


       -f, - -force
              Tells logrotate to force the rotation, even if it doesn’t  think
              this  is  necessary.   Sometimes this is useful after adding new
              entries to logrotate, or if old log files have been  removed  by
              hand,  as  the  new files will be created, and logging will con-
              tinue correctly.


       -m, - -mail <command>
              Tells logrotate which command to use  when  mailing  logs.  This
              command  should accept two arguments: 1) the subject of the mes-
              sage, and 2) the recipient. The command must then read a message
              on standard input and mail it to the recipient. The default mail
              command is /bin/mail -s.


       -s, - -state <statefile>
              Tells logrotate to use an alternate state file.  This is  useful
              if  logrotate  is being run as a different user for various sets
              of log files.  The default state file is /var/lib/logrotate/sta-
              tus.


       - -usage
              Prints a short usage message.




CONFIGURATION FILE

       logrotate  reads  everything  about the log files it should be handling
       from the series of configuration files specified on the  command  line.
       Each configuration file can set global options (local definitions over-
       ride global ones, and later  definitions  override  earlier  ones)  and
       specify  a  log file  to  rotate. A simple configuration file looks like
       this:

       # sample logrotate configuration file
       compress

       /var/log/messages {
           rotate 5
           weekly
           postrotate
                                     /sbin/killall -HUP syslogd
           endscript
       }

       "/var/log/httpd/access.log" /var/log/httpd/error.log {
           rotate 5
           mail www@my.org
           size=100k
           sharedscripts
           postrotate
                                     /sbin/killall -HUP httpd
           endscript
       }

       /var/log/news/news.crit {
           monthly
           rotate 2
           olddir /var/log/news/old
           missingok
           postrotate
                                     kill -HUP ‘cat /var/run/inn.pid‘
           endscript
           nocompress
       }

       The first few lines set global options; in the example, logs  are  com-
       pressed after they are rotated.  Note that comments may appear anywhere
       in the configuration file as long as the first non-whitespace character on the
       line is a #.

       The next section of the configuration files defined how to handle the log file
       /var/log/messages. The log will go through five weekly rotations before
       being  removed. After the log file has been rotated (but before the old
       version of the log has been compressed), the command /sbin/killall -HUP
       syslogd will be executed.

       The     next     section    defines    the    parameters    for    both
       /var/log/httpd/access.log  and  /var/log/httpd/error.log.    They   are
       rotated whenever it grows over 100k is size, and the old logs files are
       mailed (uncompressed) to www@my.org after going  through  5  rotations,
       rather  then being removed. The sharedscripts means that the postrotate
       script will only be run once(after the old logs have been  compressed),
       not  once  for  each  log which is rotated. Note that the double quotes
       around the first file name at  the  beginning  of  this  section  allows
       logrotate  to rotate logs with spaces in the name. Normal shell quoting
       rules apply, with ’, ", and \ characters supported.

       The last section defines  the  parameters  for  all  of  the  files  in
       /var/log/news.  Each  file is rotated on a monthly basis.  This is con-
       sidered a single rotation directive and if errors occur for  more  then
       one file, the log files are not compressed.

       Please  use  wild cards  with caution.  If you specify *, logrotate will
       rotate all files, including previously rotated ones.  A way around this
       is  to  use  the  olddir  directive  or  a more exact wild card (such as
       *.log).

       Here is more information on the directives which may be included  in  a
       logrotate configuration file:


       compress
              Old  versions  of log files are compressed with gzip by default.
              See also nocompress.


       compresscmd
              Specifies which command to  use  to  compress  log  files.   The
              default is gzip.  See also compress.


       uncompresscmd
              Specifies  which  command  to  use to uncompress log files.  The
              default is gunzip.


       compressext
              Specifies which extension to use on compressed logfiles, if com-
              pression is enabled.  The default follows that of the configured
              compression command.


       compressoptions
              Command line options may be passed to the  compression  program,
              if  one is in use.  The default, for gzip, is "-9" (maximum com-
              pression).


       copy   Make a copy of the log file, but don’t change  the  original  at
              all.   This option can be used, for example, to make a snapshot
              of the current log file, or when some  other  utility  needs  to
              truncate or pare the file.  When this option is used, the create
              option will have no effect, as the old log file stays in  place.


       copytruncate
              Truncate  the  original log file in place after creating a copy,
              instead of moving the old log file and optionally creating a new
              one,  It  can be used when some program cannot be told to close
              its logfile and thus might continue writing (appending)  to  the
              previous log file forever.  Note that there is a very small time
              slice between copying the file and truncating it, so  some  log-
              ging  data  might be lost.  When this option is used, the create
              option will have no effect, as the old log file stays in  place.


       create mode owner group
              Immediately after rotation (before the postrotate script is run)
              the log file is created (with the same name as the log file just
              rotated).   mode  specifies  the  mode for the log file in octal
              (the same as chmod(2)), owner specifies the username  who  will
              own  the  log  file,  and group specifies the group the log file
              will belong to. Any of the log file attributes may  be  omitted,
              in  which  case  those  attributes for the new file will use the
              same values as the original log file for the omitted attributes.
              This option can be disabled using the nocreate option.


       daily  Log files are rotated every day.


       delaycompress
              Postpone  compression of the previous log file to the next rota-
              tion cycle.  This has only effect when used in combination  with
              compress.   It  can be used when some program cannot be told to
              close its logfile and thus might continue writing to the  previ-
              ous log file for some time.


       extension ext
              Log  files  are given the final extension ext after rotation. If
              compression is used, the compression  extension  (normally  .gz)
              appears after ext.


       ifempty
              Rotate  the  log  file  even  if  it  is  empty,  overriding  the
              notifempty option (ifempty is the default).


       include file_or_directory
              Reads the file given as an argument as if it was included inline
              where  the  include  directive appears. If a directory is given,
              most of the files in that directory are read in alphabetic order
              before  processing  of  the  including  file continues. The only
              files which are ignored are files which are  not  regular  files
              (such  as directories and named pipes) and files whose names end
              with one of the taboo extensions, as specified by  the  tabooext
              directive.  The include directive may not appear inside of a log
              file definition.


       mail address
              When a log is rotated out-of-existence, it is mailed to address.
              If  no  mail should be generated by a particular log, the nomail
              directive may be used.


       mailfirst
              When using the mail command, mail the just-rotated file, instead
              of the about-to-expire file.


       maillast
              When  using  the  mail  command,  mail the about-to-expire file,
              instead of the just-rotated file (this is the default).


       missingok
              If the log file is missing, go on to the next one without  issu-
              ing an error message. See also nomissingok.


       monthly
              Log files are rotated the first time logrotate is run in a month
              (this is normally on the first day of the month).


       nocompress
              Old versions of log files are not compressed with gzip. See also
              compress.


       nocopy Do  not copy the original log file and leave it in place.  (this
              overrides the copy option).


       nocopytruncate
              Do not truncate the original log file in place after creating  a
              copy (this overrides the copytruncate option).


       nocreate
              New  log  files  are  not  created  (this  overrides  the create
              option).


       nodelaycompress
              Do not postpone compression of the previous log file to the next
              rotation cycle (this overrides the delaycompress option).


       nomail Don’t mail old log files to any address.


       nomissingok
              If  a  log  file  does  not  exist,  issue an error. This is the
              default.


       noolddir
              Logs are rotated in the same directory the log normally  resides
              in (this overrides the olddir option).


       nosharedscripts
              Run  prerotate  and postrotate scripts for every script which is
              rotated (this is the default, and  overrides  the  sharedscripts
              option).


       notifempty
              Do not rotate the log if it is empty (this overrides the ifempty
              option).


       olddir directory
              Logs are moved into directory for rotation. The  directory  must
              be  on  the  same physical device as the log file being rotated,
              and is assumed to be relative to the directory holding  the  log
              file unless an absolute path name is specified. When this option
              is used all old versions of the log end up in  directory.   This
              option may be overridden by the noolddir option.


       postrotate/endscript
              The  lines  between postrotate and endscript (both of which must
              appear on lines by themselves) are executed after the  log  file
              is  rotated.  These  directives  may only appear inside of a log
              file definition.  See prerotate as well.


       prerotate/endscript
              The lines between prerotate and endscript (both  of  which  must
              appear  on lines by themselves) are executed before the log file
              is rotated and only if the log will actually be  rotated.  These
              directives may only appear inside of a log file definition.  See
              postrotate as well.


       firstaction/endscript
              The lines between firstaction and endscript (both of which  must
              appear  on lines by themselves) are executed once before all log
              files that match the wild carded pattern are rotated, before pre-
              rotate  script is run and only if at least one log will actually
              be rotated. These directives may only appear  inside  of  a  log
              file definition. See lastaction as well.


       lastaction/endscript
              The  lines  between lastaction and endscript (both of which must
              appear on lines by themselves) are executed once after  all  log
              files  that  match  the  wild carded  pattern  are rotated, after
              postrotate script is run  and  only  if  at  least  one  log  is
              rotated.  These  directives may only appear inside of a log file
              definition. See lastaction as well.


       rotate count
              Log files are rotated <count>  times  before  being  removed  or
              mailed to the address specified in a mail directive. If count is
              0, old versions are removed rather then rotated.


       size size
              Log files are rotated when they grow bigger then size bytes.  If
              size  is  followed by M, the size if assumed to be in megabytes.
              If the k is used, the size is in kilobytes. So  size  100,  size
              100k, and size 100M are all valid.

       sharedscripts
              Normally,  prescript and postscript scripts are run for each log
              which is rotated, meaning that a single script may be run multi-
              ple  times for log file entries which match multiple files (such
              as the /var/log/news/* example). If sharedscript  is  specified,
              the scripts are only run once, no matter how many logs match the
              wild carded pattern.  However, if none of the logs in the pattern
              require  rotating,  the  scripts  will  not  be run at all. This
              option overrides the nosharedscripts option and  implies  create
              option.

       start count
              This is the number to use as the base for rotation. For example,
              if you specify 0, the logs will be created with a  .0  extension
              as they are rotated from the original log files.  If you specify
              9, log files will be created with a  .9,  skipping  0-8.   Files
              will  still  be  rotated  the number of times specified with the
              count directive.

       tabooext [+] list
              The current taboo extension list is  changed  (see  the  include
              directive  for information on the taboo extensions). If a + pre-
              cedes the list of extensions, the current taboo  extension  list
              is  augmented,  otherwise  it is replaced. At start-up, the taboo
              extension list contains .rpmorig, .rpmsave, ,v,  .swp,  .rpmnew,
              and ~.

       weekly Log  files  are  rotated if the current weekday is less then the
              weekday of the last rotation or if more then a week  has  passed
              since  the  last rotation. This is normally the same as rotating
              logs on the first day of the week, but it works better if logro-
              tate is not run every night.
FILES

       /var/lib/logrotate.status  Default state file.
       /etc/logrotate.conf        Configuration options.
-->
 </sect1>
 <sect1 xml:id="sec-tuning-syslog-logwatch">
  <title><command>logwatch</command> によるログの監視</title>

  <para><command>logwatch</command> はカスタマイズ可能でプラグインにも対応した、ログ監視スクリプトです。システムログを分析して重要な情報を抽出し、必要であれば人間にとってよりやすい形式で報告します。 <command>logwatch</command> コマンドを使用するには、 <package>logwatch</package> パッケージをインストールしてください。</para>

  <para><command>logwatch</command> はコマンドラインで直接実行することで、その場でレポートを生成することができるほか、 &crond; 等を利用することで、定期的に独自のレポートを生成することもできます。レポートは画面に表示することができるほか、ファイルに保存したり特定のアドレスにメールを送信したりすることもできます。特にメール送信については、 &crond; などでレポートを自動生成しているような場合に便利な仕組みです。</para>

  <para>コマンドラインを使用することで、 <command>logwatch</command> がレポートを生成すべきサービスの種類や時間範囲のほか、情報の細かさを指定することもできます:</para>
  <!--<remark>
     taroth 2017-12-14: for the sake of using the prompt entities
     (&prompt.user; or &prompt.root;) consistently in our docs:
     please do not mix several example commands within one screen
     and do not use '#' to refer to an example command - this makes
     it impossible to mark the individual commands with a proper
     prompt
  </remark>-->
<screen><?dbsuse-fo font-size="7pt"?># 昨日からの全てのカーネルメッセージを含む詳細レポートの生成
logwatch --service kernel --detail High --range Yesterday --print

# アーカイブされたものを含め、全ての sshd のイベントを含む詳細レポートを生成
logwatch --service sshd --detail Low --range All --archives --print

# 2005 年 5 月 5 日から 5 月 7 日までの全ての smartd のメッセージのレポートを、
# root@localhost 宛にメールで送信
logwatch --service smartd --range 'between 5/5/2005 and 5/7/2005' \
--mailto root@localhost --print
</screen>

  <para><option>--range</option> オプションは複雑な書式になっています。詳しくは <command>logwatch</command> <option>--range help</option> で表示されるヘルプをお読みください。また、問い合わせに使用できる全てのサービスを一覧で表示するには、下記のように入力して実行してください:</para>

<screen>&prompt.user;ls /usr/share/logwatch/default.conf/services/ | sed 's/\.conf//g'</screen>

  <para><command>logwatch</command> は非常に詳しくカスタマイズすることができます。しかしながら、通常は既定値の設定のままで十分です。既定の設定ファイルは <filename>/usr/share/logwatch/default.conf/</filename> 以下に書かれています。ただし、このディレクトリ内に存在するファイルは、パッケージの更新の際に上書きされてしまう設定になっていますので、変更は行わないでください。カスタマイズを行いたい場合は、 <filename>/etc/logwatch/conf/</filename> 内に設定を書き込んでください (既定で配置される設定ファイルを雛形としてお使いください) 。 <command>logwatch</command> のカスタマイズ方法について、詳しくは <filename>/usr/share/doc/packages/logwatch/HOWTO-Customize-LogWatch</filename> (英語のみ) をお読みください。具体的には、下記の設定ファイルが存在しています:</para>

  <variablelist>
   <varlistentry>
    <term><filename>logwatch.conf</filename></term>
    <listitem>
     <para>メインの設定ファイルです。既定で配置されるファイルには、様々なコメント (英語のみ) が記載されています。また、それぞれの設定オプションは、コマンドラインを指定することで上書きすることができます。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>ignore.conf</filename></term>
    <listitem>
     <para><command>logwatch</command> で全体的に無視すべき行のフィルタを記述します。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>services/*.conf</filename></term>
    <listitem>
     <para>レポートを作成することのできる各サービスに対して、個別の設定ファイルを保存しておくディレクトリです。</para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term><filename>logfiles/*.conf</filename></term>
    <listitem>
     <para>各サービスでどのログファイルを処理すべきかを示しているファイルです。</para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 <sect1 xml:id="sec-tuning-syslog-forward">
  <title>&rootuser; 宛のメールに対する転送設定</title>
  <para>システムデーモンや <systemitem class="daemon">cron</systemitem> ジョブ、 &systemd; タイマーなどのアプリケーションは、システム内の &rootuser; に対してメールを送信することがあります。また、既定ではそれぞれのユーザに対してローカルのメールボックスが作成され、ログイン時にメールの到着を知らせます。</para>
  <para>これらのアプリケーションが送信するメッセージには、システム管理者が即時に対応しなければならないセキュリティレポートやインシデント報告などが含まれる場合があります。このような緊急性の高いメールに素早く気付くことができるよう、これらのメールを各担当者のメールアドレスに転送しておくことを強くお勧めします。</para>
  <procedure xml:id="pro-tuning-syslog-forward">
   <title>&rootuser; ユーザに対するメール転送の設定</title>
   <para>&rootuser; ユーザに対するメール転送を設定するには、下記の手順を行います:</para>
   <step>
    <para>まずは <package>yast2-mail</package> パッケージをインストールします:</para>
    <screen>&prompt.root;<command>zypper in yast2-mail</command></screen>
   </step>
   <step>
    <para>対話的な &yast; メール設定モジュールを起動します:</para>
    <screen>&prompt.root;<command>yast mail</command></screen>
   </step>
   <step>
    <para><guimenu>接続の種類</guimenu> では <guimenu>常時接続</guimenu> を選択して、 <guimenu>次へ</guimenu> を押します。</para>
   </step>
   <step>
    <para><guimenu>外部送信用メールサーバ</guimenu> に、メールサーバのアドレスを入力します。必要であれば <guimenu>認証</guimenu> も設定してください。また、ネットワークを介して機密情報が送信されてしまわないよう、 <guimenu>TLS 暗号化</guimenu> を <guimenu>強制する</guimenu> にしておくことを強くお勧めします。あとは <guimenu>次へ</guimenu> を押します。</para>
   </step>
   <step>
    <para>最後に <guimenu>root 宛のメールの転送先</guimenu> に転送先のメールアドレスを入力して <guimenu>完了</guimenu> を押します。これで設定は完了です。</para>
    <important>
     <title>リモートからの SMTP 接続を受け付けてはならない問題について</title>
     <para>通常は <guimenu>リモートの SMTP 接続を許可</guimenu> を選択しては <emphasis>なりません</emphasis> 。選択してしまうと、メールを受信して中継するように動作してしまうためです。</para>
    </important>
   </step>
   <step>
    <para>あとはメールの転送設定が正しく動作していることを確認します:</para>
<screen>&prompt.user;<command>mail root</command>
subject: test
test
.</screen>
   </step>
   <step>
    <para>メールの転送が完了したかどうかは <command>mailq</command> コマンドで確認することができます。転送の設定に問題がなければ、 <guimenu>Mail queue is empty</guimenu> のように出力されるはずです。あとは転送先のメールアカウントにアクセスして、メールが正しく届いていることを確認しておいてください。</para>
   </step>
  </procedure>
  <para>なお、管理対象のマシン数とシステムイベントの通知先となる担当者数によって、様々な配信形態が考えられます:</para>
  <itemizedlist>
   <listitem>
    <para>様々なシステムから配信されるメールメッセージを、 1 人の担当者のみがアクセスするメールアカウントに転送する。</para>
   </listitem>
   <listitem>
    <para>別名やメーリングリストの機能を利用して、様々なシステムから配信されるメールメッセージを担当者全員に転送する。</para>
   </listitem>
   <listitem>
    <para>各システムに対して別々のメールアカウントを準備する。</para>
   </listitem>
  </itemizedlist>
  <para>ただし、それぞれの担当者が定期的にメールをチェックしていることが何よりも重要です。このような取り組みを促して重要なイベントを見落とさないようにするため、不必要な情報は送信しないように設定しておくことも重要です。また、アプリケーション側の設定で、関連する情報のみを送信するようにもしておいてください。</para>
 </sect1>
 <sect1 xml:id="sec-tuning-syslog-server">
  <title>中央の syslog サーバへのログメッセージの転送</title>
  <para>システムログに記録されるメッセージを、個別のシステムからネットワーク内の中央に位置するサーバに転送するように設定することができます。これにより、全てのホストが出力したログメッセージを一括で閲覧および管理できるようになるほか、不正攻撃によって特定のホストが乗っ取られてしまったような場合でも、ログを削除して足跡を隠蔽するようなことができなくなります。</para>
  <para>中央の syslog サーバにログを集約する設定を行う場合、中央の syslog サーバの設定を行ったあと、各システム (クライアント) の設定を行うことになります。</para>
  <sect2 xml:id="sec-tuning-syslog-server-setup">
   <title>中央の syslog サーバの設定</title>
   <procedure xml:id="pro-tuning-syslog-server">
    <title>中央の <systemitem>rsyslog</systemitem> サーバの設定</title>
    <para>中央に配置する syslog サーバを設定するには、下記の手順を実施します:</para>
    <step>
     <para>設定ファイル <filename>/etc/rsyslog.d/remote.conf</filename> をエディタなどで開きます。</para>
    </step>
    <step>
     <para>設定ファイル内にある <literal>UDP Syslog Server</literal> もしくは <literal>TCP Syslog Server</literal> のセクションを探すと、下記のような行があるはずです。これらの行のコメント文字 (#) を外します。また、 <systemitem class="daemon">rsyslogd</systemitem> に割り当てる IP アドレスとポートをそれぞれ設定します。</para>
     <para>TCP の場合の例:</para>
     <screen>$ModLoad imtcp.so
$UDPServerAddress <replaceable>IP</replaceable><co xml:id="co-tuning-syslog-server-ip"/>
$InputTCPServerRun <replaceable>ポート</replaceable><co xml:id="co-tuning-syslog-server-port"/></screen>
     <para>UDP の場合の例:</para>
     <screen>$ModLoad imudp.so
$UDPServerAddress <replaceable>IP</replaceable><xref linkend="co-tuning-syslog-server-ip" xrefstyle="select:label nopage"/>
$UDPServerRun <replaceable>ポート</replaceable><xref linkend="co-tuning-syslog-server-port" xrefstyle="select:label nopage"/></screen>
     <calloutlist>
      <callout arearefs="co-tuning-syslog-server-ip">
       <para><systemitem class="daemon">rsyslogd</systemitem> がメッセージを受信する際に使用するインターフェイスの IP アドレスを指定します。アドレスを指定しない場合、デーモンは全てのインターフェイスで待ち受けを行います。</para>
      </callout>
      <callout arearefs="co-tuning-syslog-server-port">
       <para><systemitem class="daemon">rsyslogd</systemitem> がメッセージを受け付けるポートを指定します。特権ポートとして規定されている 1024 未満の値を指定してください。既定値は 514 です。</para>
      </callout>
     </calloutlist>
     <important>
      <title>TCP と UDP の違いについて</title>
      <para>従来型の syslog では、 UDP プロトコルを利用してネットワーク内にメッセージを転送していました。これにより負荷を減らす効果があるものの、その分だけ信頼性が失われることになります。つまり、高負荷な環境ではログメッセージが記録されない場合があり得ることになります。 <!-- cwickert 2021-03-02 Original text before shortening --> <!-- The TCP protocol is more reliable. Messages will only get lost under <emphasis>constant</emphasis> high load, which should not occur under normal circumstances. </para> <para> Since the advantages of centralized logging could suffer from unreliability, using TCP recommended. --></para>
      <para>そのため、 UDP プロトコルではなく、信頼性の高い TCP プロトコルの使用をお勧めします。</para>
     </important>
     <note>
      <title>TCP での <literal>UDPServerAddress</literal> について</title>
      <para>TCP の例でも <literal>$UDPServerAddress</literal> という設定パラメータを指定していますが、こちらは間違いではありません。名称とは異なり、 TCP と UDP の両方に効果があります。</para>
     </note>
    </step>
    <step>
     <para>ファイルを保存してエディタを終了します。</para>
    </step>
    <step>
     <para><systemitem class="daemon">rsyslog</systemitem> サービスを再起動します:</para>
<screen>&prompt.sudo;<command>systemctl restart rsyslog.service</command></screen>
    </step>
    <step>
     <para>ファイアウオールで対象のポートを開きます。 <systemitem class="daemon">firewalld</systemitem> を TCP ポート 514 で動作させる場合は、下記のように入力して実行します:</para>
<screen>&prompt.sudo;<command>firewall-cmd --add-port <replaceable>514/tcp</replaceable> --permanent</command>
&prompt.sudo;<command>firewall-cmd --reload</command></screen>
    </step>
   </procedure>
   <para>これで中央側の syslog サーバの設定は完了です。あとはログを送信する側、つまり個別のシステム側の設定を行います。</para>
  </sect2>
  <sect2 xml:id="sec-tuning-syslog-server-client">
   <title>クライアント側の設定</title>
   <procedure xml:id="pro-tuning-syslog-client">
    <title>リモートログ記録のための <guimenu>rsyslog</guimenu> インスタンスの設定</title>
    <para>中央の syslog サーバにログを送信するようマシンを設定したい場合は、下記の手順を実施します:</para>
    <step>
     <para>設定ファイル <filename>/etc/rsyslog.d/remote.conf</filename> をエディタなどで開きます。</para>
    </step>
    <step>
     <para>設定ファイル内に下記のような行 (TCP または UDP) がありますので、これらの行のコメント文字 (#) を外したあと、 <literal>remote-host</literal> の箇所を <xref linkend="sec-tuning-syslog-server-setup"/> で設定した中央の syslog サーバのアドレスに置き換えます。</para>
     <para>TCP の場合の例:</para>
     <screen># Remote Logging using TCP for reliable delivery
# remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
*.* <replaceable>@@remote-host</replaceable></screen>
     <para>UDP の場合の例:</para>
     <screen># Remote Logging using UDP
# remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional
*.* <replaceable>@remote-host</replaceable></screen>
    </step>
    <step>
     <para>ファイルを保存してエディタを終了します。</para>
    </step>
    <step>
     <para><systemitem class="daemon">rsyslog</systemitem> サービスを再起動します:</para>
     <screen>&prompt.sudo;<command>systemctl restart rsyslog.service</command></screen>
    </step>
    <step>
     <para>あとは syslog のメッセージが正しく転送できていることを確認します:</para>
     <screen>&prompt.user;<command>logger "hello world"</command></screen>
     <para>上記を実行すると、中央の syslog サーバに <literal>hello world</literal> というメッセージが記録されているはずです。</para>
    </step>
   </procedure>
   <para>中央の syslog サーバに送信するマシンがほかにもあれば、上記の手順をそれぞれで実施してください。これにより、中央の syslog サーバに情報を集約できるようになります。</para>
  </sect2>
  <sect2 xml:id="sec-tuning-syslog-server-more">
   <title>さらなる情報</title>
   <para>ここで説明した基本的な手順は暗号化を設定していないため、信頼のできる内部ネットワーク内でのみ適用可能な手順になっています。信頼のできないネットワークを経由する場合は TLS による暗号化が必須となりますが、これには証明書のインフラを構築する必要があります。</para>
   <para>また、ここまでの説明では、遠隔からの全てのメッセージは全て同じに扱われる設定になります。ログの送信元が増えれば増えるほどメッセージも増えていくことになりますので、送信元ごとに別々のファイルに記録したり、メッセージの分類を行ったりなどの作業も必要となることでしょう。</para>
   <para>暗号化やフィルタリング、もしくはその他の高度な設定について、詳しくは <link xlink:href="https://www.rsyslog.com/doc/master/index.html#manual"/> (英語) にある <phrase role="productname">RSyslog</phrase> のドキュメンテーションをお読みください。</para>
  </sect2>
 </sect1>

 <sect1 xml:id="sec-tuning-syslog-logger">
  <title><command>logger</command> コマンドによるシステムログへの記録</title>

  <para><command>logger</command> はシステムログ内に指定した内容を出力するためのツールです。特にシェルスクリプトなどから、 rsyslogd のシステムログモジュールにメッセージを書き込みたい場合に使用します。たとえば下記のように入力して実行すると、メッセージが <filename>/var/log/messages</filename> もしくは &systemd; のジャーナル (ログ記録用のサービスを何も動作させていなければ) に書き込まれます:</para>

<screen>&prompt.user;logger -t Test "This message comes from $USER"</screen>

  <para>ログインしているユーザとホスト名によって異なりますが、ログには下記のような内容が書き込まれます:</para>

<screen>Sep 28 13:09:31 &wsII; Test: This message comes from tux</screen>
 </sect1>
</chapter>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 [
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec-security-ldap-backup">
 <title>バックアップと復元</title>

 <para>&ds389; ではオフラインとオンラインの両方のバックアップ形態に対応しています。 <command>dsctl</command> コマンドではオフラインによるデータベースバックアップを、 <command>dsconf</command> コマンドではオンラインによるデータベースバックアップを、それぞれ採取することができます。また、 LDAP サーバの設定ディレクトリをバックアップしておくことで、重大な障害が発生してサーバが復旧不可能になってしまったような場合に対応することもできます。</para>

 <sect2 xml:id="sec-security-ldap-backup-config">
  <title>サーバ設定のバックアップ</title>
  <para>LDAP のサーバ設定は <filename>/etc/dirsrv/slapd-<replaceable>インスタンス名</replaceable></filename> のディレクトリ内に存在しています。このディレクトリ内には証明書や鍵のほか、 <filename>dse.ldif</filename> ファイルが含まれています。これらは <command>tar</command> コマンドを利用して圧縮しながらバックアップすることができます:</para>
<screen>&prompt.sudo;tar caf config_slapd-<replaceable>ldap1</replaceable>_$(date +%Y-%m-%d_%H-%M-%S).tar.gz /etc/dirsrv/slapd-<replaceable>ldap1</replaceable>/
tar: メンバ名から先頭の `/' を取り除きます</screen>
  <note role="compact">
   <para>
    When running <command>tar</command>, you may see the harmless informational
    message <literal>tar: Removing leading `/' from member names</literal>.
   </para>
  </note>
  <para>
   To restore a previous configuration, unpack it to the same directory:
  </para>
  <procedure>
   <step performance="optional">
    <para>
     To avoid overwriting an existing configuring, move it:
    </para>
<screen>&prompt.sudo;<command>old /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable>/</command></screen>
   </step>
   <step>
    <para>
     Unpack the backup archive:
    </para>
<screen>&prompt.sudo;<command>tar -xvzf config_slapd-<replaceable>INSTANCE_NAME</replaceable>_<replaceable>DATE</replaceable>.tar.gz</command></screen>
   </step>
   <step>
    <para>
     Copy it to
     <filename>/etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></filename>:
    </para>
<screen>&prompt.sudo;<command>cp -r <replaceable>etc/dirsrv/slapd-INSTANCE_NAME</replaceable> /etc/dirsrv/slapd-<replaceable>INSTANCE_NAME</replaceable></command></screen>
   </step>
  </procedure>
 </sect2>

 <sect2 xml:id="sec-security-ldap-offline-backup">
  <title>Creating an offline backup of the LDAP database and restoring from it</title>
  <para><command>dsctl</command> コマンドを利用することで、オフラインバックアップを採取することができます。まずはサーバを停止させてから、インスタンス名を指定してバックアップを採取します:</para>
<screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> start
Instance "<replaceable>ldap1</replaceable>" has been started</screen>
  <para>
   Then make the backup using your instance name:
  </para>
<screen>&prompt.sudo;<command>dsctl <replaceable>INSTANCE_NAME</replaceable> db2bak</command>
db2bak successful</screen>
  <para>上記の例のとおりに実行すると、 <filename>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_26_13_03_17</filename> のようなディレクトリ内にバックアップが作成されます。</para>
  <para>バックアップから復元したい場合は、下記のようにしてバックアップを含むディレクトリを指定します:</para>
<screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> bak2db <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_26_13_03_17/</replaceable>
bak2db successful</screen>
  <para>あとはサーバを起動します:</para>
<screen>&prompt.sudo;dsctl <replaceable>ldap1</replaceable> start
Instance "<replaceable>ldap1</replaceable>" has been started</screen>
  <para>なお、 LDIF 形式でのバックアップを採取することもできます:</para>
<screen>&prompt.sudo;dsctl ldap1 db2ldif  --replication userRoot
ldiffile: <replaceable>/var/lib/dirsrv/slapd-ldap1/ldif/ldap1-userRoot-2021_07_28_08_47_30.ldif</replaceable>
db2ldif successful</screen>
  <para>LDIF 形式のバックアップから復元したい場合も同様に、ファイルを指定して復元し、サーバを起動するだけです:</para>
<screen>&prompt.sudo;dsctl ldif2db userRoot <replaceable>/var/lib/dirsrv/slapd-ldap1/ldif/ldap1-userRoot-2021_07_28_08_47_30.ldif</replaceable>
&prompt.sudo;dsctl ldap1 start</screen>
 </sect2>

 <sect2 xml:id="sec-security-ldap-online-backup">
  <title>Creating an online backup of the LDAP database and restoring from it</title>
  <para><command>dsconf</command> コマンドを利用することで、 LDAP データベースのオンラインバックアップを採取することができます:</para>
<screen>&prompt.sudo;dsconf <replaceable>ldap1</replaceable> backup create
The backup create task has finished successfully</screen>
  <para>上記のコマンドを実行すると、 <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_28_09_46_08</replaceable> のようなファイルが作成されます。復元は下記のようにして行います:</para>
  <para>
   Restore it:
  </para>
<screen>&prompt.sudo;dsconf <replaceable>ldap1</replaceable> backup restore <replaceable>/var/lib/dirsrv/slapd-ldap1/bak/ldap1-2021_07_28_09_46_08</replaceable></screen>
 </sect2>
</sect1>
